<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StockFlow ‚Äî Inventory & GST Billing</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Syne:wght@700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<style>
:root{--bg:#0d0f14;--surface:#161b24;--surface2:#1e2535;--border:#2a3347;--accent:#00e5a0;--accent2:#ff6b35;--warn:#ffd166;--danger:#ff4757;--blue:#5eb8ff;--green:#34a853;--text:#e8edf5;--muted:#7a8ba0;--radius:10px}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;font-size:14px}

/* TOPBAR */
.topbar{display:flex;align-items:center;justify-content:space-between;padding:13px 24px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;flex-wrap:wrap;gap:8px}
.logo{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;letter-spacing:-.5px}
.logo span{color:var(--accent)}
.logo-badge{background:color-mix(in srgb,var(--green) 15%,transparent);border:1px solid color-mix(in srgb,var(--green) 35%,transparent);color:var(--green);font-size:10px;padding:2px 8px;border-radius:99px;font-weight:600;letter-spacing:.3px;margin-left:8px;vertical-align:middle}
.tabs{display:flex;gap:3px;background:var(--bg);border-radius:8px;padding:3px;flex-wrap:wrap}
.tab{padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;color:var(--muted);border:none;background:none;transition:all .2s;white-space:nowrap}
.tab.active{background:var(--surface2);color:var(--text)}
.tab:hover:not(.active){color:var(--text)}
.topbar-right{display:flex;gap:8px;align-items:center}
.btn{padding:7px 14px;border-radius:8px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;transition:all .15s;display:inline-flex;align-items:center;gap:6px}
.btn-primary{background:var(--accent);color:#000}
.btn-primary:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-ghost{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-ghost:hover{background:var(--border)}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{filter:brightness(1.1)}
.btn-sm{padding:5px 11px;font-size:12px}
.btn:disabled{opacity:.4;cursor:not-allowed;transform:none!important}

/* SYNC STATUS BAR */
.sync-bar{background:var(--surface2);border-bottom:1px solid var(--border);padding:7px 26px;display:flex;align-items:center;gap:12px;font-size:12px;color:var(--muted)}
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--muted);flex-shrink:0}
.sync-dot.connected{background:var(--green);box-shadow:0 0 6px var(--green)}
.sync-dot.syncing{background:var(--warn);animation:pulse 1s infinite}
.sync-dot.error{background:var(--danger)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.sync-text{flex:1}
.sync-actions{display:flex;gap:8px;margin-left:auto}

/* MAIN & STATS */
.main{padding:20px 24px;max-width:1440px;margin:0 auto}
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:11px;margin-bottom:20px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:15px 17px;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--accent-color,var(--accent))}
.stat-label{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.5px;margin-bottom:5px}
.stat-value{font-family:'Syne',sans-serif;font-size:22px;font-weight:700}
.stat-sub{color:var(--muted);font-size:11px;margin-top:3px}

/* SETUP BANNER */
.setup-banner{background:linear-gradient(135deg,#0d1a14,#0d1424);border:1px solid color-mix(in srgb,var(--green) 30%,transparent);border-radius:12px;padding:28px;margin-bottom:22px}
.setup-banner h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:700;margin-bottom:6px}
.setup-banner h2 span{color:var(--green)}
.setup-banner p{color:var(--muted);font-size:13px;margin-bottom:18px;max-width:600px}
.setup-steps{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;margin-bottom:20px}
.setup-step{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px}
.setup-step-num{width:28px;height:28px;border-radius:50%;background:var(--green);color:#fff;font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;margin-bottom:10px}
.setup-step-title{font-weight:600;font-size:13px;margin-bottom:5px}
.setup-step-desc{font-size:12px;color:var(--muted);line-height:1.6}
.setup-input-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.setup-input{flex:1;min-width:280px;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Mono',monospace;font-size:13px;outline:none;transition:border-color .2s}
.setup-input:focus{border-color:var(--green)}

/* TOOLBAR & TABLE */
.toolbar{display:flex;gap:8px;margin-bottom:14px;align-items:center;flex-wrap:wrap}
.search-wrap{position:relative;flex:1;max-width:290px}
.search-wrap input{width:100%;padding:8px 13px 8px 34px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
.search-wrap input:focus{border-color:var(--accent)}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--muted);font-size:12px}
select{padding:8px 11px;background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;cursor:pointer}
.toolbar-right{margin-left:auto;display:flex;gap:7px}
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
table{width:100%;border-collapse:collapse}
thead th{padding:10px 13px;text-align:left;font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);font-weight:500;background:var(--surface2);border-bottom:1px solid var(--border);cursor:pointer;user-select:none}
tbody tr{border-bottom:1px solid var(--border);transition:background .1s}
tbody tr:hover{background:var(--surface2)}
tbody td{padding:10px 13px;vertical-align:middle}
.item-name{font-weight:500;font-size:13px}
.item-sku{color:var(--muted);font-family:'DM Mono',monospace;font-size:11px}
.item-barcode{color:#3a4d66;font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1.5px}
.badge{display:inline-block;padding:2px 9px;border-radius:99px;font-size:11px;font-weight:500}
.badge-retail{background:#1a3a5e;color:#5eb8ff}
.badge-warehouse{background:#2d2a14;color:#ffd166}
.badge-mfg{background:#1a3a2a;color:#00e5a0}
.stock-bar-wrap{display:flex;align-items:center;gap:7px}
.stock-bar{flex:1;height:4px;background:var(--border);border-radius:99px;max-width:65px}
.stock-fill{height:100%;border-radius:99px;transition:width .3s}
.stock-num{font-family:'DM Mono',monospace;font-size:12px;min-width:30px;text-align:right}
.actions{display:flex;gap:5px}
.icon-btn{background:none;border:1px solid var(--border);border-radius:6px;color:var(--muted);cursor:pointer;padding:4px 7px;font-size:12px;transition:all .15s}
.icon-btn:hover{border-color:var(--accent);color:var(--accent)}
.icon-btn.del:hover{border-color:var(--danger);color:var(--danger)}
.pager{display:flex;align-items:center;justify-content:space-between;padding:11px 13px;border-top:1px solid var(--border)}
.pager-info{color:var(--muted);font-size:12px}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:none;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:24px;width:560px;max-width:96vw;max-height:92vh;overflow-y:auto;animation:modalIn .2s ease}
@keyframes modalIn{from{transform:scale(.96);opacity:0}to{transform:scale(1);opacity:1}}
.modal-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:16px}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:11px}
.form-group{display:flex;flex-direction:column;gap:4px}
.form-group.full{grid-column:1/-1}
label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.form-input{padding:8px 11px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none}
.form-input:focus{border-color:var(--accent)}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:18px}

/* SHEETS SETUP MODAL */
.sheets-modal{width:680px}
.code-block{background:#070a0e;border:1px solid var(--border);border-radius:8px;padding:14px;font-family:'DM Mono',monospace;font-size:12px;line-height:1.8;overflow-x:auto;color:#cce;margin:10px 0;max-height:300px;overflow-y:auto;}
.code-block .kw{color:var(--accent)}.code-block .str{color:var(--warn)}.code-block .cm{color:#3d5c3d}
.step-pill{display:inline-block;width:22px;height:22px;border-radius:50%;background:var(--green);color:#fff;font-size:11px;font-weight:700;text-align:center;line-height:22px;margin-right:7px;flex-shrink:0}
.instruction-row{display:flex;gap:10px;align-items:flex-start;padding:10px 0;border-bottom:1px solid var(--border);font-size:13px}
.instruction-row:last-child{border-bottom:none}
.instruction-text{flex:1;color:var(--muted);line-height:1.6}
.instruction-text strong{color:var(--text)}

/* OTHER TABS */
.section-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:13px}
.section-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700}
.cards-grid{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:18px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px}
.card-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:12px;color:var(--accent)}
.card-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--border)}
.card-label{color:var(--muted);font-size:12px}
.card-val{font-family:'DM Mono',monospace;font-size:13px;font-weight:500}
.alert-item{display:flex;align-items:center;gap:11px;padding:9px 13px;border-radius:8px;margin-bottom:7px}
.alert-warn{background:color-mix(in srgb,var(--warn) 8%,transparent);border:1px solid color-mix(in srgb,var(--warn) 25%,transparent)}
.alert-crit{background:color-mix(in srgb,var(--danger) 8%,transparent);border:1px solid color-mix(in srgb,var(--danger) 25%,transparent)}
.alert-text{flex:1;font-size:13px}
.alert-action{font-size:12px;color:var(--accent);cursor:pointer;text-decoration:underline}
.empty{text-align:center;padding:44px 20px;color:var(--muted)}
.empty-icon{font-size:32px;margin-bottom:8px}

/* LOADERS & TOASTS */
.toast{position:fixed;bottom:22px;right:22px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:12px 17px;font-size:13px;z-index:300;display:flex;align-items:center;gap:9px;transform:translateY(70px);opacity:0;transition:all .3s;pointer-events:none}
.toast.show{transform:translateY(0);opacity:1}
.loading-overlay{position:fixed;inset:0;background:rgba(13,15,20,.85);z-index:500;display:none;align-items:center;justify-content:center;flex-direction:column;gap:14px}
.loading-overlay.show{display:flex}
.spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* SUPPLIERS */
.sup-table{width:100%;border-collapse:collapse}
.sup-table th,.sup-table td{padding:9px 13px;border-bottom:1px solid var(--border);font-size:13px}
.sup-table th{color:var(--muted);font-size:11px;text-transform:uppercase;letter-spacing:.4px;background:var(--surface2)}

/* CHARTS & IMPORT */
.chart-wrap{position:relative;height:190px;margin-top:8px}
.import-area{border:2px dashed var(--border);border-radius:10px;padding:22px;text-align:center;cursor:pointer;transition:border-color .2s;margin-bottom:11px}
.import-area:hover{border-color:var(--accent)}
.import-area input{display:none}

/* GST BILL (Condensed) */
#tab-gst{font-family:'DM Sans',sans-serif}
.gst-layout{display:grid;grid-template-columns:1fr 390px;gap:18px;align-items:start}
.gst-builder{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.gst-preview-wrap{position:sticky;top:74px}
.gst-preview{background:#fff;color:#111;border-radius:10px;overflow:hidden;font-family:'DM Sans',sans-serif;font-size:12px}
.bill-header{background:#12192a;color:#fff;padding:20px 22px}
.bill-company{font-size:17px;font-weight:700;margin-bottom:2px;color:#00e5a0;font-family:'Syne',sans-serif}
.bill-meta{display:grid;grid-template-columns:1fr 1fr;gap:3px;font-size:11px;color:#bbb}
.bill-section{padding:14px 20px;border-bottom:1px solid #eee}
.bill-items-table{width:100%;border-collapse:collapse;font-size:11px}
.bill-items-table th{background:#f5f7fa;padding:7px 9px;text-align:left;font-size:9px;text-transform:uppercase;color:#777;border-bottom:1px solid #e0e0e0}
.bill-items-table td{padding:7px 9px;border-bottom:1px solid #f2f2f2;vertical-align:top}
.bill-totals{padding:14px 20px;background:#f9fafb}
.bill-total-row{display:flex;justify-content:space-between;font-size:11px;padding:2px 0;color:#555}
.bill-total-row.grand{font-size:13px;font-weight:700;color:#111;border-top:2px solid #111;margin-top:5px;padding-top:7px}
.gst-section{background:var(--surface2);border-radius:8px;padding:14px;margin-bottom:12px}
.gst-section-title{font-size:11px;font-weight:600;color:var(--accent);text-transform:uppercase;margin-bottom:10px}
.gst-form-row{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:9px}
.gst-label{font-size:11px;color:var(--muted);margin-bottom:3px}
.gst-item-row{display:grid;grid-template-columns:2fr 1fr 1fr 1fr 32px;gap:5px;margin-bottom:6px;align-items:end}
.rm-btn{background:var(--danger);color:#fff;border:none;border-radius:6px;cursor:pointer;padding:8px 7px;font-size:12px}
@media print{ .topbar,.main>div:not(#tab-gst),.gst-builder,.sync-bar{display:none!important} .gst-layout{display:block!important} .gst-preview-wrap{position:static} .gst-preview{border-radius:0} body{background:#fff} }
.hidden{display:none!important}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
kbd{background:var(--surface2);border:1px solid var(--border);border-radius:4px;padding:1px 6px;font-family:'DM Mono',monospace;font-size:11px}

/* BARCODE SCAN TABS */
.scan-tab-wrap{max-width:680px;margin:0 auto}
.scan-mode-toggle{display:flex;gap:0;background:var(--surface2);border-radius:10px;padding:4px;margin-bottom:20px;border:1px solid var(--border)}
.scan-mode-btn{flex:1;padding:10px 16px;border-radius:7px;border:none;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;transition:all .2s;color:var(--muted);background:none}
.scan-mode-btn.active{color:#fff}
.scan-mode-btn.add.active{background:var(--green)}
.scan-mode-btn.deduct.active{background:var(--danger)}
.scan-hero{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:28px;margin-bottom:16px}
.scan-hero-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;margin-bottom:6px}
.scan-input-row{display:flex;gap:9px;margin-bottom:14px;align-items:flex-end}
.scan-barcode-input{flex:1;padding:13px 16px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Mono',monospace;font-size:16px;letter-spacing:2px;outline:none;transition:border-color .2s}
.scan-barcode-input:focus{border-color:var(--accent)}
.scan-barcode-input.add-mode:focus{border-color:var(--green)}
.scan-barcode-input.deduct-mode:focus{border-color:var(--danger)}
.qty-input-wrap{display:flex;flex-direction:column;gap:4px}
.qty-input-wrap label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px}
.qty-input{width:90px;padding:13px 12px;background:var(--bg);border:2px solid var(--border);border-radius:10px;color:var(--text);font-family:'DM Mono',monospace;font-size:16px;text-align:center;outline:none;transition:border-color .2s}
.qty-input:focus{border-color:var(--accent)}
.scan-result-card{background:var(--surface2);border-radius:12px;padding:20px;margin-bottom:14px;border:1px solid var(--border);display:none}
.scan-result-card.show{display:block}
.scan-result-card.add-result{border-color:color-mix(in srgb,var(--green) 40%,transparent);background:color-mix(in srgb,var(--green) 6%,var(--surface2))}
.scan-result-card.deduct-result{border-color:color-mix(in srgb,var(--danger) 40%,transparent);background:color-mix(in srgb,var(--danger) 6%,var(--surface2))}
.scan-result-name{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;margin-bottom:3px}
.scan-result-sku{font-family:'DM Mono',monospace;font-size:12px;color:var(--muted);margin-bottom:12px}
.scan-stock-change{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
.scan-stock-box{background:var(--bg);border:1px solid var(--border);border-radius:9px;padding:10px 18px;text-align:center}
.scan-stock-box .lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:3px}
.scan-stock-box .val{font-family:'Syne',sans-serif;font-size:22px;font-weight:700}
.scan-arrow{font-size:22px;color:var(--muted)}
.scan-history{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px}
.scan-history-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:13px;color:var(--muted)}
.scan-hist-item{display:flex;align-items:center;gap:11px;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px}
.scan-hist-item:last-child{border-bottom:none}
.scan-hist-badge{font-size:11px;font-weight:700;padding:3px 9px;border-radius:99px;flex-shrink:0}
.scan-hist-add{background:color-mix(in srgb,var(--green) 15%,transparent);color:var(--green)}
.scan-hist-deduct{background:color-mix(in srgb,var(--danger) 15%,transparent);color:var(--danger)}
.scan-hist-info{flex:1}
.scan-hist-time{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;flex-shrink:0}
.not-found-card{background:color-mix(in srgb,var(--warn) 8%,var(--surface2));border:1px solid color-mix(in srgb,var(--warn) 35%,transparent);border-radius:12px;padding:18px;text-align:center;display:none}
.not-found-card.show{display:block}
.scan-cam-btn{white-space:nowrap;border-color:var(--accent)!important;color:var(--accent)!important}
.reader-scan{width:100%;margin-top:12px;display:none;border-radius:8px;overflow:hidden;border:1px solid var(--border)}

/* ===== STOCK MONITOR FLOWCHART ===== */
.monitor-layout{display:grid;grid-template-columns:1fr 340px;gap:16px;align-items:start}
.monitor-flow{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px;overflow-x:auto}
.monitor-sidebar{display:flex;flex-direction:column;gap:12px}
.flow-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:18px;display:flex;align-items:center;gap:8px}
.flow-canvas{position:relative;min-height:580px;min-width:560px}
/* flow nodes */
.fn{position:absolute;border-radius:10px;padding:10px 16px;font-size:12px;font-weight:600;text-align:center;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:3px;box-shadow:0 2px 12px rgba(0,0,0,.35);cursor:default;transition:transform .2s,box-shadow .2s;z-index:2}
.fn:hover{transform:translateY(-2px);box-shadow:0 6px 22px rgba(0,0,0,.5)}
.fn-start{background:linear-gradient(135deg,#00e5a0,#00b87a);color:#000;border-radius:50px;width:130px}
.fn-process{background:var(--surface2);border:1.5px solid var(--border);color:var(--text);width:155px}
.fn-decision{background:linear-gradient(135deg,#1e2535,#2a3347);border:2px solid var(--warn);color:var(--warn);width:160px;border-radius:8px;transform:rotate(0deg)}
.fn-action-green{background:linear-gradient(135deg,#0d3322,#1a5c3a);border:1.5px solid var(--green);color:var(--green);width:155px}
.fn-action-red{background:linear-gradient(135deg,#2d0d14,#5c1a24);border:1.5px solid var(--danger);color:var(--danger);width:155px}
.fn-action-blue{background:linear-gradient(135deg,#0d1a2d,#1a3a5c);border:1.5px solid var(--blue);color:var(--blue);width:155px}
.fn-action-yellow{background:linear-gradient(135deg,#2d2400,#5c4a00);border:1.5px solid var(--warn);color:var(--warn);width:155px}
.fn-end{background:linear-gradient(135deg,#ff4757,#c0392b);color:#fff;border-radius:50px;width:130px}
.fn-label{font-size:10px;color:var(--muted);font-weight:400;margin-top:1px}
.fn-live{font-family:'DM Mono',monospace;font-size:13px;font-weight:700}
/* SVG arrows */
.flow-svg{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1}
.flow-svg path,.flow-svg line{stroke:var(--border);stroke-width:1.8;fill:none;marker-end:url(#arrowhead)}
.flow-svg text{fill:var(--muted);font-size:10px;font-family:'DM Sans',sans-serif}
/* monitor sidebar cards */
.mon-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px}
.mon-card-title{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-bottom:11px;font-weight:600}
.mon-item{display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid var(--border);font-size:12px}
.mon-item:last-child{border-bottom:none}
.mon-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.mon-name{flex:1;font-weight:500}
.mon-stock{font-family:'DM Mono',monospace;font-size:12px}
.algo-step{display:flex;gap:9px;padding:8px 0;border-bottom:1px solid var(--border);align-items:flex-start;font-size:12px}
.algo-step:last-child{border-bottom:none}
.algo-num{width:20px;height:20px;border-radius:50%;background:var(--surface2);color:var(--accent);font-size:10px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px}
.pulse-ring{animation:pulseRing 2s infinite}
@keyframes pulseRing{0%,100%{opacity:1}50%{opacity:.4}}

/* ===== VARIANTS ===== */
.var-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start}
.var-form{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px}
.var-list{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px}
.var-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:16px}
.var-product-select{width:100%;padding:9px 13px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;margin-bottom:14px}
.var-attr-row{display:grid;grid-template-columns:1fr 1fr 80px 36px;gap:7px;margin-bottom:7px;align-items:center}
.var-attr-input{padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:12px;outline:none;width:100%}
.var-attr-input:focus{border-color:var(--accent)}
.color-dot-input{width:36px;height:36px;border-radius:7px;border:1px solid var(--border);cursor:pointer;padding:2px}
.var-del-btn{background:none;border:1px solid var(--border);border-radius:7px;color:var(--danger);cursor:pointer;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:14px;transition:background .15s}
.var-del-btn:hover{background:color-mix(in srgb,var(--danger) 15%,transparent)}
.var-card{background:var(--surface2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
.var-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.var-card-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700}
.var-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.var-chip{border-radius:8px;padding:9px 12px;font-size:12px;font-weight:500;border:1.5px solid transparent;position:relative;overflow:hidden}
.var-chip-color{width:10px;height:10px;border-radius:50%;display:inline-block;margin-right:5px;border:1px solid rgba(255,255,255,.25);vertical-align:middle}
.var-chip-stock{font-family:'DM Mono',monospace;font-size:11px;color:var(--muted);margin-top:2px}
.var-chip-status{position:absolute;top:5px;right:6px;width:6px;height:6px;border-radius:50%}

/* ===== VARIANT NOTIFICATIONS ===== */
.var-notif-banner{border-radius:10px;padding:10px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;font-size:12px;animation:slideIn .25s ease}
@keyframes slideIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.var-notif-out{background:color-mix(in srgb,var(--danger) 10%,transparent);border:1px solid color-mix(in srgb,var(--danger) 35%,transparent)}
.var-notif-low{background:color-mix(in srgb,var(--warn) 10%,transparent);border:1px solid color-mix(in srgb,var(--warn) 35%,transparent)}
.var-notif-icon{font-size:15px;flex-shrink:0}
.var-notif-text{flex:1;line-height:1.5}
.var-notif-restock{font-size:11px;color:var(--accent);cursor:pointer;text-decoration:underline;flex-shrink:0}
.var-reorder-badge{display:inline-flex;align-items:center;gap:4px;font-size:10px;font-family:'DM Mono',monospace;background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:2px 7px;margin-top:3px}
.var-chip-reorder-input{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;text-align:center;padding:3px 5px;margin-top:5px;outline:none}
.var-chip-reorder-input:focus{border-color:var(--accent)}
.var-chip-reorder-label{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-top:4px}
.var-notif-panel{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
.var-notif-panel-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.notif-bell{position:relative;cursor:pointer;display:inline-flex}
.notif-bell-count{position:absolute;top:-5px;right:-7px;background:var(--danger);color:#fff;font-size:9px;font-weight:700;border-radius:99px;padding:1px 5px;min-width:16px;text-align:center;line-height:14px;animation:pulse 1.5s infinite}
.var-chip-bar{height:3px;border-radius:99px;background:var(--border);margin-top:5px;overflow:hidden}
.var-chip-bar-fill{height:100%;border-radius:99px;transition:width .4s}
.var-alert-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;animation:pulse 1.5s infinite}

/* ===== PRODUCTION TAB ===== */
.prod-layout{display:grid;grid-template-columns:340px 1fr;gap:16px;align-items:start}
.prod-form-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px;position:sticky;top:80px}
.prod-list-wrap{display:flex;flex-direction:column;gap:14px}
.prod-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:16px}
.prod-section{background:var(--surface2);border-radius:10px;padding:14px;margin-bottom:12px}
.prod-section-label{font-size:10px;color:var(--accent);text-transform:uppercase;letter-spacing:.6px;font-weight:700;margin-bottom:10px}
.prod-input{width:100%;padding:8px 11px;background:var(--bg);border:1px solid var(--border);border-radius:7px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:border-color .2s}
.prod-input:focus{border-color:var(--accent)}
.prod-row{display:grid;grid-template-columns:1.5fr 0.8fr 0.8fr 30px;gap:6px;margin-bottom:6px;align-items:center}
.prod-row-label{display:grid;grid-template-columns:1.5fr 0.8fr 0.8fr 30px;gap:6px;margin-bottom:4px}
.prod-row-label div{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px}
.prod-del{background:none;border:1px solid var(--border);border-radius:6px;color:var(--danger);cursor:pointer;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;transition:background .15s}
.prod-del:hover{background:color-mix(in srgb,var(--danger) 15%,transparent)}
.prod-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px}
.prod-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:16px}
.prod-card-name{font-family:'Syne',sans-serif;font-size:15px;font-weight:700}
.prod-card-sub{font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px}
.prod-cost-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:16px}
.prod-cost-box{background:var(--surface2);border-radius:9px;padding:12px;text-align:center}
.prod-cost-box-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:4px}
.prod-cost-box-val{font-family:'Syne',sans-serif;font-size:16px;font-weight:700}
.prod-materials-table{width:100%;border-collapse:collapse;font-size:12px;margin-bottom:10px}
.prod-materials-table th{background:var(--surface2);padding:7px 10px;text-align:left;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;border-bottom:1px solid var(--border)}
.prod-materials-table td{padding:7px 10px;border-bottom:1px solid var(--border)}
.prod-margin-bar{height:6px;border-radius:99px;background:var(--border);overflow:hidden;margin-top:6px}
.prod-margin-bar-fill{height:100%;border-radius:99px;transition:width .5s}
.prod-batch-tag{display:inline-flex;align-items:center;gap:5px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:3px 9px;font-size:11px;font-family:'DM Mono',monospace}

/* ===== ITERATION TAB ===== */
.iter-layout{display:grid;grid-template-columns:1fr 380px;gap:16px;align-items:start}
.iter-form-wrap{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:22px}
.iter-log-wrap{display:flex;flex-direction:column;gap:12px}
.iter-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:16px}
.iter-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;position:relative;overflow:hidden}
.iter-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px}
.iter-card.saving::before{background:var(--accent)}
.iter-card.testing::before{background:var(--warn)}
.iter-card.success::before{background:var(--green)}
.iter-card.failed::before{background:var(--danger)}
.iter-card-title{font-weight:600;font-size:13px;margin-bottom:5px}
.iter-card-meta{font-size:11px;color:var(--muted);margin-bottom:10px;display:flex;gap:10px;flex-wrap:wrap}
.iter-tag{display:inline-block;padding:2px 8px;border-radius:99px;font-size:10px;font-weight:600}
.iter-tag-saving{background:color-mix(in srgb,var(--accent) 15%,transparent);color:var(--accent)}
.iter-tag-testing{background:color-mix(in srgb,var(--warn) 15%,transparent);color:var(--warn)}
.iter-tag-success{background:color-mix(in srgb,var(--green) 15%,transparent);color:var(--green)}
.iter-tag-failed{background:color-mix(in srgb,var(--danger) 15%,transparent);color:var(--danger)}
.iter-impact{display:flex;align-items:center;gap:8px;background:var(--surface2);border-radius:8px;padding:9px 12px;margin-bottom:8px;font-size:12px}
.iter-saving-amt{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--accent)}
.iter-timeline{position:relative;padding-left:22px}
.iter-timeline::before{content:'';position:absolute;left:7px;top:0;bottom:0;width:1px;background:var(--border)}
.iter-tl-dot{position:absolute;left:0;width:15px;height:15px;border-radius:50%;border:2px solid var(--border);background:var(--surface)}
.iter-tl-item{position:relative;margin-bottom:16px;padding-bottom:16px}
.iter-tl-item:last-child{margin-bottom:0;padding-bottom:0}
.iter-compare{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.iter-compare-box{background:var(--surface2);border-radius:8px;padding:10px;font-size:12px}
.iter-compare-label{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px}
.iter-compare-val{font-family:'DM Mono',monospace;font-size:14px;font-weight:600}
.var-summary{display:flex;gap:14px;flex-wrap:wrap;margin-top:10px;padding-top:10px;border-top:1px solid var(--border)}
.var-summary-item{font-size:11px;color:var(--muted)}
.var-summary-item span{color:var(--text);font-weight:600;font-family:'DM Mono',monospace}

/* ===== VARIANT AXIS BUILDER ===== */
.var-axis{background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.var-axis-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.var-axis-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;font-weight:700;flex:1}
.var-axis-name-input{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:5px 10px;font-family:'DM Sans',sans-serif;font-size:13px;flex:1;outline:none;transition:border-color .2s}
.var-axis-name-input:focus{border-color:var(--accent)}
.var-axis-values{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.var-axis-tag{display:inline-flex;align-items:center;gap:5px;background:var(--bg);border:1px solid var(--border);border-radius:99px;padding:4px 10px;font-size:12px;cursor:default}
.var-axis-tag-del{background:none;border:none;color:var(--danger);cursor:pointer;font-size:13px;line-height:1;padding:0 2px}
.var-axis-add-wrap{display:flex;gap:6px}
.var-axis-value-input{background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);padding:5px 10px;font-family:'DM Sans',sans-serif;font-size:12px;flex:1;outline:none}
.var-axis-value-input:focus{border-color:var(--accent)}
.var-axis-color-input{width:36px;height:36px;border:1px solid var(--border);border-radius:6px;cursor:pointer;padding:2px;background:var(--bg)}

/* ===== MATRIX TABLE ===== */
.matrix-th{background:var(--surface2);padding:8px 12px;font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;font-weight:700;white-space:nowrap;border:1px solid var(--border)}
.matrix-th.combo-col{color:var(--text);font-weight:600;text-transform:none;font-size:12px}
.matrix-td{padding:6px 8px;border:1px solid var(--border);vertical-align:middle}
.matrix-input{width:60px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'DM Mono',monospace;font-size:12px;text-align:center;padding:4px 6px;outline:none}
.matrix-input:focus{border-color:var(--accent)}
.matrix-input.warn-input{border-color:var(--warn)}
.matrix-barcode-input{width:110px;background:var(--bg);border:1px solid var(--border);border-radius:5px;color:var(--text);font-family:'DM Mono',monospace;font-size:11px;padding:4px 6px;outline:none}
.matrix-barcode-input:focus{border-color:var(--accent)}
.matrix-combo-label{display:flex;align-items:center;gap:6px;white-space:nowrap;font-size:12px}
.matrix-color-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;border:1px solid rgba(255,255,255,.15)}
.matrix-sku-badge{font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);background:var(--surface);border-radius:4px;padding:1px 5px;margin-left:4px}
</style>
</head>
<body>

<div class="topbar">
  <div style="display:flex;align-items:center;gap:6px">
    <div class="logo">Stock<span>Flow</span><span class="logo-badge">üìä Google Sheets</span></div>
  </div>
  <div class="tabs">
    <button class="tab active" onclick="switchTab('inventory',this)">üì¶ Inventory</button>
    <button class="tab" onclick="switchTab('addstock',this)">üì• Add Stock</button>
    <button class="tab" onclick="switchTab('deductstock',this)">üì§ Deduct Stock</button>
    <button class="tab" onclick="switchTab('monitor',this)">üîÑ Stock Monitor</button>
    <button class="tab" onclick="switchTab('variants',this)">üé® Variants</button>
    <button class="tab" onclick="switchTab('charts',this)">üìä Charts</button>
    <button class="tab" onclick="switchTab('suppliers',this)">üè¢ Suppliers</button>
    <button class="tab" onclick="switchTab('mva',this)">üè≠ MVA</button>
    <button class="tab" onclick="switchTab('production',this)">‚öôÔ∏è Production</button>
    <button class="tab" onclick="switchTab('iteration',this)">üîÅ Iteration</button>
    <button class="tab" onclick="switchTab('alerts',this)">‚ö† Alerts <span id="alert-count" style="background:var(--danger);color:#fff;border-radius:99px;padding:1px 6px;font-size:10px;margin-left:2px;vertical-align:middle"></span></button>
    <button class="tab" onclick="switchTab('gst',this)">üßæ GST Bill</button>
  </div>
  <div class="topbar-right">
    <button class="btn btn-ghost btn-sm" onclick="showSheetsSetup()">‚öôÔ∏è Sheet Setup</button>
    <button class="btn btn-ghost btn-sm" onclick="openImportExport()">‚¨Ü Import/Export</button>
    <button class="btn btn-ghost btn-sm" id="sync-btn" onclick="syncAll()" disabled>üîÑ Sync Now</button>
    <button class="btn btn-primary btn-sm" onclick="openModal()">+ Add Item</button>
  </div>
</div>

<div class="sync-bar">
  <div class="sync-dot" id="sync-dot"></div>
  <span class="sync-text" id="sync-text">Not connected ‚Äî paste your Google Apps Script URL to connect</span>
  <div class="sync-actions">
    <span id="last-sync-text" style="color:var(--muted);font-size:11px"></span>
  </div>
</div>

<div class="main">
  <div class="setup-banner" id="setup-banner">
    <h2>üîå Connect to <span>Google Sheets</span></h2>
    <p>Your inventory and supplier data will be stored securely in a Google Sheet ‚Äî shareable with your team, editable directly in Sheets, and synced in real-time. Takes about 5 minutes to set up.</p>
    <div class="setup-steps">
      <div class="setup-step">
        <div class="setup-step-num">1</div>
        <div class="setup-step-title">Create Google Sheet</div>
        <div class="setup-step-desc">Go to <strong>sheets.google.com</strong> ‚Üí New blank sheet ‚Üí Name it "StockFlow Database"</div>
      </div>
      <div class="setup-step">
        <div class="setup-step-num">2</div>
        <div class="setup-step-title">Add Apps Script</div>
        <div class="setup-step-desc">In your Sheet: <strong>Extensions ‚Üí Apps Script</strong> ‚Üí paste the script ‚Üí Deploy as Web App</div>
      </div>
      <div class="setup-step">
        <div class="setup-step-num">3</div>
        <div class="setup-step-title">Paste URL here</div>
        <div class="setup-step-desc">Copy the deployment URL and paste it below ‚Äî your data syncs automatically!</div>
      </div>
    </div>
    <div class="setup-input-row">
      <input class="setup-input" id="sheet-url-input" placeholder="https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec" />
      <button class="btn btn-green" onclick="connectSheet()">üîå Connect Sheet</button>
      <button class="btn btn-ghost" onclick="showSheetsSetup()">üìã View Setup Guide</button>
    </div>
  </div>

  <div class="stats" id="stats-row"></div>

  <div id="tab-inventory">
    <div class="toolbar">
      <div class="search-wrap">
        <span class="search-icon">üîç</span>
        <input type="text" id="search" placeholder="Search name, SKU, barcode..." oninput="renderTable()">
      </div>
      <select id="filter-cat" onchange="renderTable()">
        <option value="">All Categories</option>
        <option>Retail</option><option>Warehouse</option><option>Manufacturing</option>
      </select>
      <select id="filter-status" onchange="renderTable()">
        <option value="">All Status</option>
        <option value="ok">In Stock</option>
        <option value="low">Low Stock</option>
        <option value="out">Out of Stock</option>
      </select>
      <div class="toolbar-right">
        <button class="btn btn-ghost btn-sm" onclick="sortBy('name')">Name ‚Üï</button>
        <button class="btn btn-ghost btn-sm" onclick="sortBy('stock')">Stock ‚Üï</button>
        <button class="btn btn-ghost btn-sm" onclick="sortBy('price')">Price ‚Üï</button>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr>
          <th>Item / SKU / Barcode</th><th>Category</th><th>Stock</th>
          <th>Price (‚Çπ)</th><th>Reorder</th><th>Location</th><th>Supplier</th><th>Status</th><th>Actions</th>
        </tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      <div id="empty-state" class="empty hidden"><div class="empty-icon">üì¶</div><div>No items found.</div></div>
      <div class="pager" id="pager"></div>
    </div>
  </div>

  <div id="tab-addstock" class="hidden">
    <div class="scan-tab-wrap">
      <div class="scan-hero" style="border-color:color-mix(in srgb,var(--green) 35%,transparent)">
        <div class="scan-hero-title" style="color:var(--green)">üì• Add Stock via Barcode</div>
        <p style="color:var(--muted);font-size:13px;margin-bottom:18px">Scan or type a product barcode. Stock will be added to inventory automatically.</p>
        <div class="scan-input-row">
          <div style="flex:1;display:flex;flex-direction:column;gap:4px">
            <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">Barcode (Scan or Type)</label>
            <div style="display:flex;gap:7px">
              <input class="scan-barcode-input add-mode" id="add-barcode-input" placeholder="Scan barcode here..." autocomplete="off"
                onkeydown="if(event.key==='Enter')processBarcodeScan('add')">
              <button class="btn btn-ghost btn-sm scan-cam-btn" onclick="toggleScanCamera('add')">üì∑ Camera</button>
            </div>
          </div>
          <div class="qty-input-wrap">
            <label>Quantity</label>
            <input class="qty-input" id="add-qty-input" type="number" min="1" value="1">
          </div>
          <button class="btn btn-green" onclick="processBarcodeScan('add')" style="height:46px;align-self:flex-end">‚ûï Add</button>
        </div>
        <div id="add-cam-reader" class="reader-scan"></div>
        <div class="not-found-card" id="add-not-found">
          <div style="font-size:28px;margin-bottom:6px">üîç</div>
          <div style="font-weight:600;margin-bottom:3px">Barcode not found in inventory</div>
          <div style="color:var(--muted);font-size:12px;margin-bottom:12px" id="add-not-found-code"></div>
          <button class="btn btn-primary btn-sm" onclick="openModalWithBarcode()">‚ûï Register as New Item</button>
        </div>
        <div class="scan-result-card add-result" id="add-result-card">
          <div class="scan-result-name" id="add-result-name"></div>
          <div class="scan-result-sku" id="add-result-sku"></div>
          <div class="scan-stock-change">
            <div class="scan-stock-box"><div class="lbl">Before</div><div class="val" id="add-before" style="color:var(--muted)"></div></div>
            <div class="scan-arrow">‚Üí</div>
            <div class="scan-stock-box"><div class="lbl">Added</div><div class="val" style="color:var(--green)" id="add-delta"></div></div>
            <div class="scan-arrow">‚Üí</div>
            <div class="scan-stock-box"><div class="lbl">New Stock</div><div class="val" style="color:var(--green)" id="add-after"></div></div>
          </div>
        </div>
      </div>
      <div class="scan-history" id="add-history-wrap">
        <div class="scan-history-title">üìã Recent Add Transactions</div>
        <div id="add-history-list"><div style="color:var(--muted);font-size:13px">No transactions yet this session.</div></div>
      </div>
    </div>
  </div>

  <div id="tab-deductstock" class="hidden">
    <div class="scan-tab-wrap">
      <div class="scan-hero" style="border-color:color-mix(in srgb,var(--danger) 35%,transparent)">
        <div class="scan-hero-title" style="color:var(--danger)">üì§ Deduct Stock / Sell via Barcode</div>
        <p style="color:var(--muted);font-size:13px;margin-bottom:18px">Scan or type a product barcode when selling or using stock. Inventory reduces automatically.</p>
        <div class="scan-input-row">
          <div style="flex:1;display:flex;flex-direction:column;gap:4px">
            <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">Barcode (Scan or Type)</label>
            <div style="display:flex;gap:7px">
              <input class="scan-barcode-input deduct-mode" id="deduct-barcode-input" placeholder="Scan barcode here..." autocomplete="off"
                onkeydown="if(event.key==='Enter')processBarcodeScan('deduct')">
              <button class="btn btn-ghost btn-sm scan-cam-btn" onclick="toggleScanCamera('deduct')" style="border-color:var(--danger)!important;color:var(--danger)!important">üì∑ Camera</button>
            </div>
          </div>
          <div class="qty-input-wrap">
            <label>Quantity</label>
            <input class="qty-input" id="deduct-qty-input" type="number" min="1" value="1">
          </div>
          <button class="btn" style="background:var(--danger);color:#fff;height:46px;align-self:flex-end" onclick="processBarcodeScan('deduct')">‚ûñ Deduct</button>
        </div>
        <div id="deduct-cam-reader" class="reader-scan"></div>
        <div class="not-found-card" id="deduct-not-found">
          <div style="font-size:28px;margin-bottom:6px">üîç</div>
          <div style="font-weight:600;margin-bottom:3px">Barcode not found in inventory</div>
          <div style="color:var(--muted);font-size:12px" id="deduct-not-found-code"></div>
        </div>
        <div class="scan-result-card deduct-result" id="deduct-result-card">
          <div class="scan-result-name" id="deduct-result-name"></div>
          <div class="scan-result-sku" id="deduct-result-sku"></div>
          <div class="scan-stock-change">
            <div class="scan-stock-box"><div class="lbl">Before</div><div class="val" id="deduct-before" style="color:var(--muted)"></div></div>
            <div class="scan-arrow">‚Üí</div>
            <div class="scan-stock-box"><div class="lbl">Deducted</div><div class="val" style="color:var(--danger)" id="deduct-delta"></div></div>
            <div class="scan-arrow">‚Üí</div>
            <div class="scan-stock-box"><div class="lbl">New Stock</div><div class="val" id="deduct-after"></div></div>
          </div>
        </div>
        <div id="deduct-warn" style="display:none;background:color-mix(in srgb,var(--warn) 10%,transparent);border:1px solid color-mix(in srgb,var(--warn) 40%,transparent);border-radius:9px;padding:12px 16px;margin-top:10px;font-size:13px;color:var(--warn)">
          ‚ö†Ô∏è <strong>Warning:</strong> <span id="deduct-warn-msg"></span>
        </div>
      </div>
      <div class="scan-history" id="deduct-history-wrap">
        <div class="scan-history-title">üìã Recent Deduct / Sale Transactions</div>
        <div id="deduct-history-list"><div style="color:var(--muted);font-size:13px">No transactions yet this session.</div></div>
      </div>
    </div>
  </div>

  <!-- STOCK MONITOR TAB -->
  <div id="tab-monitor" class="hidden">
    <div class="monitor-layout">
      <div class="monitor-flow">
        <div class="flow-title">üîÑ Live Stock Monitoring Algorithm <span class="pulse-ring" style="color:var(--accent);font-size:11px;margin-left:6px">‚óè LIVE</span></div>
        <div class="flow-canvas" id="flow-canvas">
          <svg class="flow-svg" id="flow-svg">
            <defs>
              <marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                <polygon points="0 0, 8 3, 0 6" fill="#2a3347"/>
              </marker>
            </defs>
          </svg>
        </div>
      </div>
      <div class="monitor-sidebar">
        <div class="mon-card">
          <div class="mon-card-title">üìä Algorithm Output ‚Äî Right Now</div>
          <div id="algo-output-list"></div>
        </div>
        <div class="mon-card">
          <div class="mon-card-title">üî¥ Out of Stock</div>
          <div id="mon-out-list"><div style="color:var(--muted);font-size:12px">None</div></div>
        </div>
        <div class="mon-card">
          <div class="mon-card-title">üü° Low Stock ‚Äî Reorder Now</div>
          <div id="mon-low-list"><div style="color:var(--muted);font-size:12px">All good!</div></div>
        </div>
        <div class="mon-card">
          <div class="mon-card-title">üü¢ Healthy Stock</div>
          <div id="mon-ok-list"><div style="color:var(--muted);font-size:12px">No items yet</div></div>
        </div>
        <div class="mon-card">
          <div class="mon-card-title">‚öôÔ∏è Algorithm Steps</div>
          <div class="algo-step"><div class="algo-num">1</div><div>Scan all inventory items</div></div>
          <div class="algo-step"><div class="algo-num">2</div><div>Check stock vs reorder point</div></div>
          <div class="algo-step"><div class="algo-num">3</div><div>If stock = 0 ‚Üí flag OUT</div></div>
          <div class="algo-step"><div class="algo-num">4</div><div>If stock ‚â§ reorder ‚Üí flag LOW</div></div>
          <div class="algo-step"><div class="algo-num">5</div><div>If stock > reorder ‚Üí flag OK</div></div>
          <div class="algo-step"><div class="algo-num">6</div><div>Calculate suggested reorder qty</div></div>
          <div class="algo-step"><div class="algo-num">7</div><div>Auto-alert &amp; sync to sheet</div></div>
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:4px" onclick="runMonitorAlgo()">‚ñ∂ Run Algorithm Now</button>
      </div>
    </div>
  </div>

  <!-- VARIANTS TAB -->
  <div id="tab-variants" class="hidden">
    <div class="var-layout">

      <!-- LEFT FORM: Define attributes + generate matrix -->
      <div class="var-form" style="position:sticky;top:72px;max-height:calc(100vh - 90px);overflow-y:auto">
        <div class="var-title">üé® Multi-Attribute Variants</div>
        <div style="color:var(--muted);font-size:12px;margin-bottom:16px">Define multiple attributes (Color, Size, etc.) ‚Äî all combinations are auto-generated as a stock matrix.</div>

        <div style="margin-bottom:14px">
          <label style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;display:block;margin-bottom:5px">Parent Product</label>
          <select class="var-product-select" id="var-product-sel"><option value="">‚Äî Select a product ‚Äî</option></select>
        </div>

        <!-- Attribute axes builder -->
        <div id="var-axes-container"></div>
        <button class="btn btn-ghost btn-sm" onclick="addVarAxis()" style="width:100%;margin-bottom:14px">+ Add Another Attribute (e.g. Size)</button>

        <!-- Quick presets -->
        <div style="background:var(--surface2);border-radius:10px;padding:12px;margin-bottom:14px">
          <div style="font-size:11px;color:var(--accent);font-weight:600;text-transform:uppercase;margin-bottom:8px">‚ö° Quick Presets</div>
          <div style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="btn btn-ghost btn-sm" onclick="applyPreset('bandana')">üêï Dog Bandana</button>
            <button class="btn btn-ghost btn-sm" onclick="applyPreset('tshirt')">üëï T-Shirt</button>
            <button class="btn btn-ghost btn-sm" onclick="applyPreset('shoes')">üëü Shoes</button>
            <button class="btn btn-ghost btn-sm" onclick="applyPreset('colorsonly')">üåà Colors Only</button>
            <button class="btn btn-ghost btn-sm" onclick="applyPreset('sizesonly')">üìê Sizes Only</button>
          </div>
        </div>

        <!-- Default stock, reorder, cost, sell price -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:14px">
          <div>
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">Default Stock</div>
            <input class="var-attr-input" id="var-default-stock" type="number" min="0" value="0" style="width:100%">
          </div>
          <div>
            <div style="font-size:11px;color:var(--warn);text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">Default Min ‚ö†</div>
            <input class="var-attr-input" id="var-default-reorder" type="number" min="0" value="5" style="width:100%;border-color:var(--warn)">
          </div>
          <div>
            <div style="font-size:11px;color:var(--blue);text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">Default Cost ‚Çπ</div>
            <input class="var-attr-input" id="var-default-cost" type="number" min="0" step="0.01" value="0" style="width:100%;border-color:var(--blue)" placeholder="Production cost">
          </div>
          <div>
            <div style="font-size:11px;color:var(--accent);text-transform:uppercase;letter-spacing:.3px;margin-bottom:4px">Default Sell Price ‚Çπ</div>
            <input class="var-attr-input" id="var-default-price" type="number" min="0" step="0.01" value="0" style="width:100%" placeholder="Selling price">
          </div>
        </div>

        <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="generateMatrix()">‚ö° Generate Combinations</button>
        <button class="btn btn-ghost" style="width:100%;font-size:12px" onclick="clearVarForm()">Clear</button>
      </div>

      <!-- RIGHT: Cards + Matrix editor -->
      <div class="var-list">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div class="var-title" style="margin-bottom:0">üì¶ Products with Variants</div>
        </div>
        <!-- Matrix editor (shown after generate) -->
        <div id="var-matrix-editor" style="display:none;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:16px">
          <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:4px" id="matrix-editor-title">Combination Matrix</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px" id="matrix-editor-sub"></div>
          <div style="overflow-x:auto">
            <table id="matrix-table" style="border-collapse:collapse;font-size:12px;min-width:100%"></table>
          </div>
          <div style="margin-top:14px;display:flex;gap:8px">
            <button class="btn btn-primary" style="flex:1" onclick="saveVariants()">üíæ Save All Combinations</button>
            <button class="btn btn-ghost" onclick="document.getElementById('var-matrix-editor').style.display='none'">‚úï Cancel</button>
          </div>
        </div>
        <!-- Existing cards -->
        <div id="var-cards-container"><div style="color:var(--muted);font-size:13px;text-align:center;padding:40px 20px">No variants yet.<br>Select a product and generate combinations.</div></div>
      </div>
    </div>
  </div>

  <div id="tab-charts" class="hidden">
    <div class="cards-grid" style="grid-template-columns:2fr 1fr">
      <div class="card"><div class="card-title">üìà Stock Levels by Item</div><div class="chart-wrap"><canvas id="chart-stock"></canvas></div></div>
      <div class="card"><div class="card-title">ü•ß Value by Segment</div><div class="chart-wrap"><canvas id="chart-pie"></canvas></div></div>
      <div class="card" style="grid-column:1/-1"><div class="card-title">üí∞ Top Items by Value</div><div class="chart-wrap" style="height:230px"><canvas id="chart-value"></canvas></div></div>
    </div>
  </div>

  <div id="tab-suppliers" class="hidden">
    <div class="section-head">
      <div class="section-title">Supplier Tracker</div>
      <button class="btn btn-primary btn-sm" onclick="openSupplierModal()">+ Add Supplier</button>
    </div>
    <div class="table-wrap">
      <table class="sup-table">
        <thead><tr><th>Supplier</th><th>Contact</th><th>Email</th><th>Phone</th><th>GSTIN</th><th>Items</th><th>Last Order</th><th>Actions</th></tr></thead>
        <tbody id="sup-tbody"></tbody>
      </table>
      <div id="sup-empty" class="empty hidden"><div class="empty-icon">üè¢</div><div>No suppliers yet. Add one!</div></div>
    </div>
  </div>

  <div id="tab-mva" class="hidden">
    <div class="section-head"><div class="section-title">Manufacturing Value Added Dashboard</div></div>
    <div class="cards-grid" id="mva-content"></div>
  </div>

  <!-- ========== PRODUCTION TAB ========== -->
  <div id="tab-production" class="hidden">
    <div class="prod-layout">

      <!-- LEFT: Form -->
      <div class="prod-form-wrap">
        <div class="prod-title">‚öôÔ∏è Define Production Recipe</div>

        <div class="prod-section">
          <div class="prod-section-label">üì¶ Finished Product</div>
          <select class="prod-input" id="prod-item-sel" style="margin-bottom:9px">
            <option value="">‚Äî Select finished product ‚Äî</option>
          </select>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px">Batch Size (units)</div>
              <input class="prod-input" id="prod-batch" type="number" min="1" value="10" placeholder="e.g. 10">
            </div>
            <div>
              <div style="font-size:10px;color:var(--muted);margin-bottom:4px;text-transform:uppercase;letter-spacing:.3px">Selling Price (‚Çπ)</div>
              <input class="prod-input" id="prod-sell-price" type="number" step="0.01" placeholder="auto from item">
            </div>
          </div>
        </div>

        <!-- Raw Materials -->
        <div class="prod-section">
          <div class="prod-section-label" style="display:flex;justify-content:space-between;align-items:center">
            <span>üß™ Raw Materials</span>
            <button class="btn btn-ghost btn-sm" onclick="addRawRow()" style="font-size:11px;padding:3px 9px">+ Add</button>
          </div>
          <div class="prod-row-label"><div>Material</div><div>Qty</div><div>Cost/Unit ‚Çπ</div><div></div></div>
          <div id="raw-rows-container"></div>
        </div>

        <!-- Labor -->
        <div class="prod-section">
          <div class="prod-section-label" style="display:flex;justify-content:space-between;align-items:center">
            <span>üë∑ Labour Cost</span>
            <button class="btn btn-ghost btn-sm" onclick="addLaborRow()" style="font-size:11px;padding:3px 9px">+ Add</button>
          </div>
          <div class="prod-row-label"><div>Role / Task</div><div>Hours</div><div>Rate ‚Çπ/hr</div><div></div></div>
          <div id="labor-rows-container"></div>
        </div>

        <!-- Overhead: electricity, time, misc -->
        <div class="prod-section">
          <div class="prod-section-label" style="display:flex;justify-content:space-between;align-items:center">
            <span>‚ö° Overhead Costs</span>
            <button class="btn btn-ghost btn-sm" onclick="addOverheadRow()" style="font-size:11px;padding:3px 9px">+ Add</button>
          </div>
          <div class="prod-row-label"><div>Item</div><div>Units</div><div>Cost/Unit ‚Çπ</div><div></div></div>
          <div id="overhead-rows-container"></div>
          <div style="margin-top:9px;padding-top:9px;border-top:1px solid var(--border)">
            <div style="font-size:10px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:.3px">‚è± Production Time</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:7px">
              <div>
                <div style="font-size:10px;color:var(--muted);margin-bottom:3px">Hours per batch</div>
                <input class="prod-input" id="prod-time-hrs" type="number" min="0" step="0.5" value="2" placeholder="hrs">
              </div>
              <div>
                <div style="font-size:10px;color:var(--muted);margin-bottom:3px">Electricity (‚Çπ/batch)</div>
                <input class="prod-input" id="prod-electricity" type="number" min="0" step="0.5" value="0" placeholder="‚Çπ">
              </div>
            </div>
          </div>
        </div>

        <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="saveRecipe()">üíæ Save Recipe & Calculate</button>
        <button class="btn btn-ghost" style="width:100%;font-size:12px" onclick="clearProdForm()">Clear Form</button>
      </div>

      <!-- RIGHT: Recipes list -->
      <div class="prod-list-wrap" id="prod-cards-container">
        <div style="color:var(--muted);font-size:13px;text-align:center;padding:60px 20px">
          <div style="font-size:32px;margin-bottom:10px">‚öôÔ∏è</div>
          No recipes yet. Select a product and fill in the costs.
        </div>
      </div>
    </div>
  </div>

  <!-- ========== ITERATION TAB ========== -->
  <div id="tab-iteration" class="hidden">
    <div class="iter-layout">

      <!-- LEFT: Log new iteration -->
      <div class="iter-form-wrap">
        <div class="iter-title">üîÅ Log Cost Improvement Cycle</div>
        <div style="margin-bottom:11px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Product</div>
          <select class="prod-input" id="iter-product-sel"><option value="">‚Äî Select product ‚Äî</option></select>
        </div>
        <div style="margin-bottom:11px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Improvement Title</div>
          <input class="prod-input" id="iter-title" placeholder="e.g. Switch to cheaper wax supplier">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px">
          <div>
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Category</div>
            <select class="prod-input" id="iter-cat">
              <option value="material">Raw Material</option>
              <option value="labor">Labour</option>
              <option value="overhead">Overhead / Electricity</option>
              <option value="process">Process / Time</option>
              <option value="supplier">Supplier Change</option>
              <option value="design">Design / Formula</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div>
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Status</div>
            <select class="prod-input" id="iter-status">
              <option value="testing">üß™ Testing</option>
              <option value="saving">üí° Idea / Planning</option>
              <option value="success">‚úÖ Implemented</option>
              <option value="failed">‚ùå Failed / Rejected</option>
            </select>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:11px">
          <div>
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Cost Before (‚Çπ/batch)</div>
            <input class="prod-input" id="iter-cost-before" type="number" step="0.01" placeholder="e.g. 250">
          </div>
          <div>
            <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Cost After (‚Çπ/batch)</div>
            <input class="prod-input" id="iter-cost-after" type="number" step="0.01" placeholder="e.g. 210">
          </div>
        </div>
        <div style="margin-bottom:11px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">What Changed</div>
          <textarea class="prod-input" id="iter-what" rows="2" placeholder="Describe what you changed and why..."></textarea>
        </div>
        <div style="margin-bottom:11px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Result / Observation</div>
          <textarea class="prod-input" id="iter-result" rows="2" placeholder="Quality impact, quantity impact, any issues..."></textarea>
        </div>
        <div style="margin-bottom:15px">
          <div style="font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-bottom:5px">Next Step / Action</div>
          <input class="prod-input" id="iter-next" placeholder="e.g. Order 50kg trial batch from new supplier">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-bottom:8px" onclick="saveIteration()">üìù Log Iteration</button>
        <button class="btn btn-ghost" style="width:100%;font-size:12px" onclick="clearIterForm()">Clear</button>

        <!-- Summary panel -->
        <div style="margin-top:18px;background:var(--surface2);border-radius:10px;padding:16px">
          <div style="font-size:11px;color:var(--accent);font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">üìä Improvement Summary</div>
          <div id="iter-summary-panel"><div style="color:var(--muted);font-size:12px">Log iterations to see savings</div></div>
        </div>
      </div>

      <!-- RIGHT: Timeline log -->
      <div class="iter-log-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px">
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700">Improvement Timeline</div>
          <div style="display:flex;gap:7px">
            <select class="prod-input" id="iter-filter-prod" onchange="renderIterations()" style="padding:5px 9px;font-size:12px;width:auto">
              <option value="">All Products</option>
            </select>
            <select class="prod-input" id="iter-filter-status" onchange="renderIterations()" style="padding:5px 9px;font-size:12px;width:auto">
              <option value="">All Status</option>
              <option value="testing">Testing</option>
              <option value="saving">Planning</option>
              <option value="success">Implemented</option>
              <option value="failed">Failed</option>
            </select>
          </div>
        </div>
        <div id="iter-timeline-container">
          <div style="color:var(--muted);font-size:13px;text-align:center;padding:60px 20px">
            <div style="font-size:32px;margin-bottom:10px">üîÅ</div>
            No iterations logged yet. Start tracking your cost improvements!
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="tab-alerts" class="hidden">
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="card" style="border-color:color-mix(in srgb,var(--warn) 30%,transparent)">
        <div class="card-title" style="color:var(--warn)">‚ö† Parent Stock Alerts</div>
        <div id="alerts-content"></div>
      </div>
      <div class="card" style="border-color:color-mix(in srgb,var(--danger) 30%,transparent)">
        <div class="card-title" style="color:var(--accent);display:flex;align-items:center;justify-content:space-between">
          <span>üé® Variant / Child Stock Alerts</span>
          <span id="var-alert-badge" style="background:var(--danger);color:#fff;border-radius:99px;padding:2px 10px;font-size:11px;font-weight:700;display:none">0</span>
        </div>
        <div id="var-alerts-content"><div style="color:var(--muted);font-size:13px">üéâ All variants well stocked!</div></div>
      </div>
    </div>
  </div>

  <div id="tab-gst" class="hidden">
    <div class="gst-layout">
      <div class="gst-builder">
        <div class="section-head" style="margin-bottom:14px">
          <div class="section-title">üßæ GST Invoice Builder</div>
          <div style="display:flex;gap:7px">
            <button class="btn btn-ghost btn-sm" onclick="clearBill()">üóë Clear</button>
            <button class="btn btn-primary btn-sm" onclick="printBill()">üñ® Print / PDF</button>
          </div>
        </div>
        <div class="gst-section">
          <div class="gst-section-title">Seller / Business Details</div>
          <div class="gst-form-row">
            <div><div class="gst-label">Business Name</div><input class="form-input" id="g-sell-name" value="Your Business Name" oninput="updateBill()"></div>
            <div><div class="gst-label">GSTIN</div><input class="form-input" id="g-sell-gstin" placeholder="22AAAAA0000A1Z5" oninput="updateBill()"></div>
          </div>
          <div class="gst-form-row one"><div><div class="gst-label">Address</div><input class="form-input" id="g-sell-addr" placeholder="Street, City, State ‚Äî PIN" oninput="updateBill()"></div></div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px">
            <div><div class="gst-label">Phone</div><input class="form-input" id="g-sell-phone" placeholder="+91..." oninput="updateBill()"></div>
            <div><div class="gst-label">Email</div><input class="form-input" id="g-sell-email" placeholder="you@email.com" oninput="updateBill()"></div>
            <div><div class="gst-label">State</div><input class="form-input" id="g-sell-state" placeholder="State" oninput="updateBill()"></div>
          </div>
        </div>
        <div class="gst-section">
          <div class="gst-section-title">Buyer Details</div>
          <div class="gst-form-row">
            <div><div class="gst-label">Buyer Name / Company</div><input class="form-input" id="g-buy-name" placeholder="Customer / Company" oninput="updateBill()"></div>
            <div><div class="gst-label">GSTIN (if registered)</div><input class="form-input" id="g-buy-gstin" placeholder="Optional" oninput="updateBill()"></div>
          </div>
          <div class="gst-form-row one"><div><div class="gst-label">Address</div><input class="form-input" id="g-buy-addr" placeholder="Buyer billing address" oninput="updateBill()"></div></div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px">
            <div><div class="gst-label">Phone</div><input class="form-input" id="g-buy-phone" placeholder="+91..." oninput="updateBill()"></div>
            <div><div class="gst-label">State</div><input class="form-input" id="g-buy-state" placeholder="State" oninput="updateBill()"></div>
            <div><div class="gst-label">Place of Supply</div><input class="form-input" id="g-pos" placeholder="State code e.g. 09" oninput="updateBill()"></div>
          </div>
        </div>
        <div class="gst-section">
          <div class="gst-section-title">Invoice Details</div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:9px;margin-bottom:9px">
            <div><div class="gst-label">Invoice No.</div><input class="form-input" id="g-inv-no" value="INV-2026-001" oninput="updateBill()"></div>
            <div><div class="gst-label">Invoice Date</div><input class="form-input" type="date" id="g-inv-date" oninput="updateBill()"></div>
            <div><div class="gst-label">Due Date</div><input class="form-input" type="date" id="g-due-date" oninput="updateBill()"></div>
          </div>
          <div class="gst-form-row">
            <div><div class="gst-label">Transaction Type</div>
              <select class="form-input" id="g-txn-type" onchange="updateBill()"><option value="intra">Intra-State (CGST + SGST)</option><option value="inter">Inter-State (IGST)</option></select>
            </div>
            <div><div class="gst-label">Payment Terms</div><input class="form-input" id="g-pay-terms" placeholder="e.g. Net 30 days" oninput="updateBill()"></div>
          </div>
        </div>
        <div class="gst-section">
          <div class="gst-section-title" style="display:flex;justify-content:space-between;align-items:center">
            <span>Line Items</span><button class="btn btn-primary btn-sm" onclick="addBillItem()">+ Row</button>
          </div>
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr 32px;gap:5px;margin-bottom:5px">
            <div class="gst-label">Item / Description</div><div class="gst-label">Qty</div><div class="gst-label">Rate (‚Çπ)</div><div class="gst-label">GST %</div><div></div>
          </div>
          <div id="bill-items-container"></div>
          <div style="margin-top:9px">
            <div class="gst-label" style="margin-bottom:4px">Quick add from inventory:</div>
            <select class="form-input" id="inv-quick-add" onchange="quickAddItem(this)" style="width:100%"><option value="">‚Äî Pick an inventory item ‚Äî</option></select>
          </div>
        </div>
        <div class="gst-section">
          <div class="gst-section-title">Additional Info</div>
          <div class="gst-form-row">
            <div><div class="gst-label">Bank / UPI Details</div><input class="form-input" id="g-bank" placeholder="A/c or UPI ID" oninput="updateBill()"></div>
            <div><div class="gst-label">Discount (‚Çπ)</div><input class="form-input" id="g-discount" type="number" value="0" min="0" oninput="updateBill()"></div>
          </div>
          <div class="gst-form-row one"><div>
            <div class="gst-label">Notes / Terms</div>
            <textarea class="form-input" id="g-notes" rows="2" placeholder="Thank you for your business!" oninput="updateBill()"></textarea>
          </div></div>
        </div>
      </div>
      <div class="gst-preview-wrap">
        <div class="gst-preview" id="bill-preview"></div>
        <div style="display:flex;gap:8px;margin-top:11px" class="bill-actions">
          <button class="btn btn-primary" style="flex:1" onclick="printBill()">üñ® Print / Save PDF</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title" id="modal-title">Add New Item</div>
    <div class="form-grid">
      <div class="form-group"><label>Item Name</label><input class="form-input" id="f-name" placeholder="Product name"></div>
      <div class="form-group"><label>SKU</label><input class="form-input" id="f-sku" placeholder="SKU-001"></div>
      <div class="form-group full">
        <label>Barcode (EAN/UPC)</label>
        <div style="display:flex;gap:7px">
          <input class="form-input" id="f-barcode" placeholder="Scan or enter barcode" style="flex:1">
          <button class="btn btn-ghost btn-sm" onclick="toggleScanner()" style="white-space:nowrap; border-color: var(--accent); color: var(--accent);">üì∑ Scan</button>
          <button class="btn btn-ghost btn-sm" onclick="document.getElementById('f-barcode').value='890'+Math.floor(Math.random()*10000000000).toString().padStart(10,'0')" style="white-space:nowrap">üîÄ Auto</button>
        </div>
        <div id="reader" style="width: 100%; margin-top: 10px; display: none; border-radius: 8px; overflow: hidden; border: 1px solid var(--border);"></div>
      </div>
      <div class="form-group"><label>Category</label>
        <select class="form-input" id="f-cat"><option>Retail</option><option>Warehouse</option><option>Manufacturing</option></select>
      </div>
      <div class="form-group"><label>Location / Shelf</label><input class="form-input" id="f-loc" placeholder="A3-Shelf2"></div>
      <div class="form-group"><label>Stock Qty</label><input class="form-input" id="f-stock" type="number" min="0" placeholder="0"></div>
      <div class="form-group"><label>Max Capacity</label><input class="form-input" id="f-max" type="number" min="1" placeholder="100"></div>
      <div class="form-group"><label>Reorder Point</label><input class="form-input" id="f-reorder" type="number" min="0" placeholder="10"></div>
      <div class="form-group"><label>Unit Price (‚Çπ)</label><input class="form-input" id="f-price" type="number" step="0.01" placeholder="0.00"></div>
      <div class="form-group"><label>HSN Code</label><input class="form-input" id="f-hsn" placeholder="e.g. 8481"></div>
      <div class="form-group"><label>GST Rate</label>
        <select class="form-input" id="f-gst"><option value="0">0%</option><option value="5">5%</option><option value="12">12%</option><option value="18" selected>18%</option><option value="28">28%</option></select>
      </div>
      <div class="form-group full"><label>Supplier</label><input class="form-input" id="f-supplier" placeholder="Supplier name"></div>
      <div class="form-group full"><label>Notes</label><input class="form-input" id="f-notes" placeholder="Optional notes"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveItem()">Save Item</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="sup-modal">
  <div class="modal">
    <div class="modal-title" id="sup-modal-title">Add Supplier</div>
    <div class="form-grid">
      <div class="form-group"><label>Supplier Name</label><input class="form-input" id="s-name" placeholder="Company name"></div>
      <div class="form-group"><label>Contact Person</label><input class="form-input" id="s-contact" placeholder="Name"></div>
      <div class="form-group"><label>Email</label><input class="form-input" id="s-email" type="email" placeholder="email@supplier.com"></div>
      <div class="form-group"><label>Phone</label><input class="form-input" id="s-phone" placeholder="+91 XXXXX XXXXX"></div>
      <div class="form-group"><label>GSTIN</label><input class="form-input" id="s-gstin" placeholder="22AAAAA0000A1Z5"></div>
      <div class="form-group"><label>Last Order Date</label><input class="form-input" id="s-lastorder" type="date"></div>
      <div class="form-group full"><label>Address</label><input class="form-input" id="s-addr" placeholder="Full address"></div>
      <div class="form-group full"><label>Notes (payment terms, lead time)</label><input class="form-input" id="s-notes" placeholder="e.g. Net 30, 7 day lead time"></div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeSupplierModal()">Cancel</button>
      <button class="btn btn-primary" onclick="saveSupplier()">Save Supplier</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="ie-modal">
  <div class="modal" style="width:430px">
    <div class="modal-title">Import / Export</div>
    <div style="display:flex;gap:8px;margin-bottom:13px">
      <button class="btn btn-ghost" style="flex:1" onclick="exportCSV()">‚¨á CSV</button>
      <button class="btn btn-ghost" style="flex:1" onclick="exportJSON()">‚¨á JSON</button>
    </div>
    <div class="import-area" onclick="document.getElementById('csv-file').click()">
      <div style="font-size:22px;margin-bottom:6px">üìÇ</div>
      <div style="color:var(--muted);font-size:12px">Click to import CSV<br><small>Columns: name, sku, barcode, category, stock, maxCapacity, reorderPoint, price, hsn, gstRate, location, supplier</small></div>
      <input type="file" id="csv-file" accept=".csv" onchange="importCSV(event)">
    </div>
    <div class="modal-actions"><button class="btn btn-ghost" onclick="closeIE()">Close</button></div>
  </div>
</div>

<div class="modal-overlay" id="sheets-modal">
  <div class="modal sheets-modal">
    <div class="modal-title">üìä Google Sheets Setup Guide</div>
    <div style="background:var(--surface2);border-radius:8px;padding:14px;margin-bottom:16px;font-size:13px;color:var(--muted)">
      Follow these steps once ‚Äî takes ~5 minutes. After setup, all your inventory data lives securely in a Google Sheet.
    </div>
    <div class="instruction-row"><span class="step-pill">1</span><div class="instruction-text"><strong>Create a new Google Sheet</strong><br>Go to <a href="https://sheets.google.com" target="_blank" style="color:var(--accent)">sheets.google.com</a> ‚Üí click <strong>"Blank"</strong> ‚Üí rename it to <kbd>StockFlow Database</kbd></div></div>
    <div class="instruction-row"><span class="step-pill">2</span><div class="instruction-text"><strong>Open Apps Script editor</strong><br>In your Sheet, click <strong>Extensions ‚Üí Apps Script</strong>. A new tab opens with a code editor.</div></div>
    <div class="instruction-row"><span class="step-pill">3</span><div class="instruction-text"><strong>Paste this script</strong> ‚Äî delete everything in the editor first, then paste:
        <div class="code-block">
<span class="cm">// StockFlow Google Sheets API (Full Sync)</span>
<span class="kw">function</span> doGet(e) {
  <span class="kw">if</span> (e.parameter.action === <span class="str">'ping'</span>) <span class="kw">return</span> ContentService.createTextOutput(JSON.stringify({ status: <span class="str">'ok'</span>, sheet: <span class="str">'StockFlow DB'</span> })).setMimeType(ContentService.MimeType.JSON);
  
  <span class="kw">const</span> ss = SpreadsheetApp.getActiveSpreadsheet();
  <span class="kw">const</span> response = {
    items: getSheetData(ss.getSheetByName(<span class="str">"Items"</span>)),
    suppliers: getSheetData(ss.getSheetByName(<span class="str">"Suppliers"</span>))
  };
  <span class="kw">return</span> ContentService.createTextOutput(JSON.stringify(response)).setMimeType(ContentService.MimeType.JSON);
}

<span class="kw">function</span> doPost(e) {
  <span class="kw">try</span> {
    <span class="kw">const</span> ss = SpreadsheetApp.getActiveSpreadsheet();
    <span class="kw">const</span> data = JSON.parse(e.postData.contents);
    
    <span class="kw">if</span> (data.items) writeSheetData(ss.getSheetByName(<span class="str">"Items"</span>), data.items, [<span class="str">"id"</span>,<span class="str">"name"</span>,<span class="str">"sku"</span>,<span class="str">"barcode"</span>,<span class="str">"category"</span>,<span class="str">"stock"</span>,<span class="str">"maxCapacity"</span>,<span class="str">"reorderPoint"</span>,<span class="str">"price"</span>,<span class="str">"hsn"</span>,<span class="str">"gstRate"</span>,<span class="str">"location"</span>,<span class="str">"supplier"</span>,<span class="str">"notes"</span>]);
    <span class="kw">if</span> (data.suppliers) writeSheetData(ss.getSheetByName(<span class="str">"Suppliers"</span>), data.suppliers, [<span class="str">"id"</span>,<span class="str">"name"</span>,<span class="str">"contact"</span>,<span class="str">"email"</span>,<span class="str">"phone"</span>,<span class="str">"gstin"</span>,<span class="str">"addr"</span>,<span class="str">"lastOrder"</span>,<span class="str">"notes"</span>]);
    
    <span class="kw">return</span> ContentService.createTextOutput(JSON.stringify({ status: <span class="str">"success"</span> })).setMimeType(ContentService.MimeType.JSON);
  } <span class="kw">catch</span>(err) {
    <span class="kw">return</span> ContentService.createTextOutput(JSON.stringify({ status: <span class="str">"error"</span>, msg: err.toString() })).setMimeType(ContentService.MimeType.JSON);
  }
}

<span class="kw">function</span> getSheetData(sheet) {
  <span class="kw">if</span> (!sheet) <span class="kw">return</span> [];
  <span class="kw">const</span> data = sheet.getDataRange().getValues();
  <span class="kw">if</span> (data.length < 2) <span class="kw">return</span> []; 
  <span class="kw">const</span> headers = data[0], result = [];
  <span class="kw">for</span> (<span class="kw">let</span> i = 1; i < data.length; i++) {
    <span class="kw">const</span> obj = {};
    <span class="kw">for</span> (<span class="kw">let</span> j = 0; j < headers.length; j++) obj[headers[j]] = data[i][j];
    result.push(obj);
  }
  <span class="kw">return</span> result;
}

<span class="kw">function</span> writeSheetData(sheet, data, headers) {
  <span class="kw">if</span> (!sheet) {
    <span class="kw">const</span> ss = SpreadsheetApp.getActiveSpreadsheet();
    sheet = ss.insertSheet(headers.includes(<span class="str">"sku"</span>) ? <span class="str">"Items"</span> : <span class="str">"Suppliers"</span>);
  }
  sheet.clearContents();
  sheet.appendRow(headers); 
  <span class="kw">if</span> (data.length === 0) <span class="kw">return</span>;
  <span class="kw">const</span> rows = data.map(item => headers.map(header => item[header] === undefined ? <span class="str">""</span> : item[header]));
  sheet.getRange(2, 1, rows.length, headers.length).setValues(rows);
}
        </div>
      </div>
    </div>
    <div class="instruction-row"><span class="step-pill">4</span><div class="instruction-text"><strong>Deploy as Web App</strong><br>Click <strong>Deploy ‚Üí New deployment</strong> ‚Üí Type: <kbd>Web app</kbd> ‚Üí Execute as: <kbd>Me</kbd> ‚Üí Who has access: <kbd>Anyone</kbd> ‚Üí click <strong>Deploy</strong> ‚Üí <strong>Authorize</strong> when prompted.</div></div>
    <div class="instruction-row"><span class="step-pill">5</span><div class="instruction-text"><strong>Copy the Web App URL</strong><br>After deploying, copy the URL and paste it below.</div></div>
    <div style="background:color-mix(in srgb,var(--warn) 8%,transparent);border:1px solid color-mix(in srgb,var(--warn) 25%,transparent);border-radius:8px;padding:13px;margin-top:14px;font-size:12px;color:var(--text)">‚ö†Ô∏è <strong>Important:</strong> When you re-deploy after changes, always click <strong>Deploy ‚Üí Manage deployments ‚Üí Edit (pencil) ‚Üí New version</strong>.</div>
    <div style="margin-top:16px">
      <div style="font-size:12px;color:var(--muted);margin-bottom:8px">Paste your Web App URL here:</div>
      <div style="display:flex;gap:8px">
        <input class="form-input" id="sheet-url-modal" placeholder="https://script.google.com/macros/s/.../exec" style="flex:1;font-family:'DM Mono',monospace;font-size:12px">
        <button class="btn btn-green" onclick="connectFromModal()">üîå Connect</button>
      </div>
    </div>
    <div class="modal-actions" style="margin-top:12px"><button class="btn btn-ghost" onclick="closeSheetsModal()">Close</button></div>
  </div>
</div>

<div class="loading-overlay" id="loading"><div class="spinner"></div><div style="color:var(--muted);font-size:13px" id="loading-text">Syncing with Google Sheets...</div></div>
<div class="toast" id="toast"><span id="toast-icon">‚úÖ</span><span id="toast-msg">Done!</span></div>

<script>
/* ============================================================
   CONFIG & STATE
   ============================================================ */
let SCRIPT_URL = localStorage.getItem('sf_sheet_url') || '';
let isConnected = false;
let isSyncing = false;

let items = JSON.parse(localStorage.getItem('sf_v3') || '[]');
let suppliers = JSON.parse(localStorage.getItem('sf_sup_v3') || '[]');
let nextId = items.length > 0 ? Math.max(...items.map(i=>Number(i.id)||0))+1 : 1;
let nextSupId = suppliers.length > 0 ? Math.max(...suppliers.map(s=>Number(s.id)||0))+1 : 1;

let editingId=null, editingSupId=null;
let sortField=null, sortDir=1;
const PAGE=10; let page=0;
let charts={};
let billRowId=0;

/* ============================================================
   BARCODE SCANNER (MOBILE CAMERA)
   ============================================================ */
let html5QrcodeScanner = null;

function toggleScanner() {
  const readerDiv = document.getElementById('reader');
  
  // If scanner is currently open, close it
  if (readerDiv.style.display === 'block') {
    if (html5QrcodeScanner) {
      html5QrcodeScanner.clear();
      html5QrcodeScanner = null;
    }
    readerDiv.style.display = 'none';
    return;
  }

  // Open scanner
  readerDiv.style.display = 'block';
  
  // Initialize the scanner
  html5QrcodeScanner = new Html5QrcodeScanner(
    "reader",
    { fps: 10, qrbox: { width: 250, height: 100 }, supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA] },
    /* verbose= */ false
  );
  
  html5QrcodeScanner.render(onScanSuccess, onScanFailure);
}

function onScanSuccess(decodedText, decodedResult) {
  // Populate the input with the scanned barcode
  document.getElementById('f-barcode').value = decodedText;
  
  // Play a little beep sound (optional but nice)
  let beep = new Audio('data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq/9jDAAAABzOEAAAAAABzhAAAB//OAAAA//OAAAA//OAAAA//OAAAA//OAAAA//OAAAA');
  beep.play().catch(e=>console.log(e)); // Catch error if browser blocks autoplay

  // Stop scanning and hide the viewfinder
  if (html5QrcodeScanner) {
    html5QrcodeScanner.clear();
    html5QrcodeScanner = null;
  }
  document.getElementById('reader').style.display = 'none';
  
  toast('üì∑', 'Barcode Scanned!');
}

function onScanFailure(error) {
  // We ignore failures because it continuously fires while trying to focus/read
}

/* ============================================================
   BARCODE ADD / DEDUCT STOCK
   ============================================================ */
const scanHistory = [];
let addCamScanner = null;
let deductCamScanner = null;
let lastNotFoundBarcode = '';

function processBarcodeScan(mode) {
  const inputEl = document.getElementById(mode+'-barcode-input');
  const qtyEl   = document.getElementById(mode+'-qty-input');
  const barcode  = inputEl.value.trim();
  const qty      = parseInt(qtyEl.value) || 1;

  document.getElementById(mode+'-result-card').classList.remove('show');
  document.getElementById(mode+'-not-found').classList.remove('show');
  if(mode==='deduct') document.getElementById('deduct-warn').style.display='none';

  if(!barcode){ toast('‚ö†Ô∏è','Please enter or scan a barcode'); inputEl.focus(); return; }
  if(qty < 1){ toast('‚ö†Ô∏è','Quantity must be at least 1'); return; }

  // ‚îÄ‚îÄ 1. Try matching a VARIANT first (by barcode or full SKU) ‚îÄ‚îÄ
  let matchedVariant = null, matchedVarParent = null, matchedVarIdx = -1, matchedVarPid;
  const varMatch = findVariantByBarcode(barcode);
  if(varMatch){
    matchedVarPid    = varMatch.pid;
    matchedVarIdx    = varMatch.comboIdx;
    matchedVariant   = varMatch.combo;
    matchedVarParent = items.find(i=>i.id==varMatch.pid);
  }

  // ‚îÄ‚îÄ 2. Fallback: try matching a parent item ‚îÄ‚îÄ
  const item = matchedVarParent || items.find(i => (i.barcode && i.barcode === barcode) || i.sku === barcode);

  if(!item && !matchedVariant){
    lastNotFoundBarcode = barcode;
    document.getElementById(mode+'-not-found').classList.add('show');
    document.getElementById(mode+'-not-found-code').textContent = 'Scanned: ' + barcode;
    toast('‚ùå','Barcode not found in inventory');
    inputEl.value=''; inputEl.focus();
    return;
  }

  // ‚îÄ‚îÄ 3. Apply stock change ‚îÄ‚îÄ
  const before = item.stock;
  let variantBefore = matchedVariant ? matchedVariant.stock : null;
  let resultLabel = item.name;
  let variantNote = '';

  if (mode === 'add') {
    item.stock += qty;
    if (matchedVariant) {
      matchedVariant.stock += qty;
      const comboName = matchedVariant.labels ? matchedVariant.labels.join('/') : (matchedVariant.value||'');
      variantNote = ` (${comboName} +${qty})`;
    }
  } else {
    if (qty > item.stock) {
      document.getElementById('deduct-warn').style.display='block';
      document.getElementById('deduct-warn-msg').textContent = `Only ${item.stock} in stock, cannot deduct ${qty}.`;
      inputEl.value=''; inputEl.focus();
      return;
    }
    item.stock -= qty;
    if (matchedVariant) {
      const varStock = matchedVariant.stock;
      matchedVariant.stock = Math.max(0, varStock - qty);
      const comboName = matchedVariant.labels ? matchedVariant.labels.join('/') : (matchedVariant.value||'');
      variantNote = ` (${comboName} -${qty})`;
    }
  }

  const after = item.stock;

  // ‚îÄ‚îÄ 4. Update variant in variants object ‚îÄ‚îÄ
  if (matchedVariant && matchedVarPid !== undefined) {
    const vData = variants[matchedVarPid];
    const comboArr = vData.combos || vData.attrs;
    comboArr[matchedVarIdx] = matchedVariant;
    localStorage.setItem('sf_variants', JSON.stringify(variants));
    renderVarCards();
  }

  // ‚îÄ‚îÄ 5. Show result card ‚îÄ‚îÄ
  const isAdd = mode === 'add';
  document.getElementById(mode+'-result-name').textContent = item.name + variantNote;
  document.getElementById(mode+'-result-sku').textContent  = item.sku + (item.barcode?' ¬∑ '+item.barcode:'') + (matchedVariant?' ‚Üí Variant: '+matchedVariant.value:'');
  document.getElementById(mode+'-before').textContent = before;
  document.getElementById(mode+'-delta').textContent  = (isAdd?'+':'-')+qty;
  document.getElementById(mode+'-after').textContent  = after;
  if(!isAdd) document.getElementById('deduct-after').style.color = after <= item.reorderPoint ? 'var(--danger)' : 'var(--accent)';
  document.getElementById(mode+'-result-card').classList.add('show');

  // ‚îÄ‚îÄ 6. Low/out stock warning ‚îÄ‚îÄ
  if(!isAdd){
    if(after === 0){
      document.getElementById('deduct-warn').style.display='block';
      document.getElementById('deduct-warn-msg').textContent = `${item.name} is now OUT OF STOCK!`;
    } else if(after <= item.reorderPoint){
      document.getElementById('deduct-warn').style.display='block';
      document.getElementById('deduct-warn-msg').textContent = `${item.name} is now low (${after} left, reorder point: ${item.reorderPoint})`;
    }
  }

  // ‚îÄ‚îÄ 7. Build scan log entry ‚îÄ‚îÄ
  const scanLog = {
    timestamp : new Date().toISOString(),
    mode,
    name     : item.name + (matchedVariant?' ['+matchedVariant.value+']':''),
    sku      : item.sku + (matchedVariant?matchedVariant.skuSuffix:''),
    barcode  : barcode,
    qty,
    before,
    after,
    variantValue : matchedVariant ? (matchedVariant.labels ? matchedVariant.labels.join(' / ') : (matchedVariant.value||'')) : '',
    parentSku    : item.sku
  };

  addToScanHistory(mode, item, qty, before, after, matchedVariant);
  toast('‚úÖ', `${isAdd?'+':'-'}${qty}${variantNote} ‚Üí ${item.name} stock: ${after}`);

  inputEl.value = '';
  qtyEl.value = 1;
  inputEl.focus();
  render();
  syncToSheet(scanLog);
}

function addToScanHistory(mode, item, qty, before, after, variant=null){
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
  scanHistory.unshift({mode, name:item.name, sku:item.sku, qty, before, after, time:timeStr, variant:variant?variant.value:null});
  if(scanHistory.length > 50) scanHistory.pop();
  renderScanHistory(mode);
}

function renderScanHistory(mode){
  const listEl = document.getElementById(mode+'-history-list');
  const relevant = scanHistory.filter(h=>h.mode===mode);
  if(!relevant.length){ listEl.innerHTML='<div style="color:var(--muted);font-size:13px">No transactions yet this session.</div>'; return; }
  listEl.innerHTML = relevant.map(h=>{
    const badge = h.mode==='add'
      ? `<span class="scan-hist-badge scan-hist-add">+${h.qty}</span>`
      : `<span class="scan-hist-badge scan-hist-deduct">-${h.qty}</span>`;
    const varTag = h.variant ? `<span style="background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:1px 6px;font-size:10px;margin-left:4px;color:var(--accent)">${h.variant}</span>` : '';
    return `<div class="scan-hist-item">
      ${badge}
      <div class="scan-hist-info"><strong>${h.name}</strong>${varTag} <span style="color:var(--muted);font-size:11px">${h.sku}</span><br><span style="color:var(--muted);font-size:12px">${h.before} ‚Üí ${h.after}</span></div>
      <div class="scan-hist-time">${h.time}</div>
    </div>`;
  }).join('');
}

function openModalWithBarcode(){
  openModal();
  setTimeout(()=>{
    document.getElementById('f-barcode').value = lastNotFoundBarcode;
    toast('üìã','Barcode pre-filled ‚Äî complete the item details');
  }, 200);
}

// Camera toggles for add/deduct tabs
function toggleScanCamera(mode){
  const readerId = mode+'-cam-reader';
  const readerEl = document.getElementById(readerId);
  let scanner = mode==='add' ? addCamScanner : deductCamScanner;

  if(scanner){
    scanner.clear().catch(()=>{});
    if(mode==='add') addCamScanner=null; else deductCamScanner=null;
    readerEl.style.display='none';
    return;
  }

  readerEl.style.display='block';
  const newScanner = new Html5QrcodeScanner(readerId,
    {fps:10, qrbox:{width:280, height:110}, supportedScanTypes:[Html5QrcodeScanType.SCAN_TYPE_CAMERA]}, false);

  newScanner.render((decodedText)=>{
    document.getElementById(mode+'-barcode-input').value = decodedText;
    new Audio('data:audio/mp3;base64,//NExAAAAANIAAAAAExBTUUzLjEwMKqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq/9jDAAAABzOEAAAAAABzhAAAB//OAAAA//OAAAA//OAAAA//OAAAA//OAAAA//OAAAA//OAAAA').play().catch(()=>{});
    newScanner.clear().catch(()=>{});
    readerEl.style.display='none';
    if(mode==='add') addCamScanner=null; else deductCamScanner=null;
    toast('üì∑','Barcode scanned!');
    setTimeout(()=>processBarcodeScan(mode), 300);
  }, ()=>{});

  if(mode==='add') addCamScanner=newScanner; else deductCamScanner=newScanner;
}

/* ============================================================
   GOOGLE SHEETS API LOGIC
   ============================================================ */
async function pingSheet() {
  if (!SCRIPT_URL) return false;
  try {
    setSyncState('syncing', 'Connecting to Google Sheets...');
    const res = await fetch(`${SCRIPT_URL}?action=ping&t=${Date.now()}`);
    const data = await res.json();
    if (data.status === 'ok') {
      isConnected = true;
      setSyncState('connected', `Connected to sheet: "${data.sheet}"`);
      document.getElementById('sync-btn').disabled = false;
      document.getElementById('setup-banner').classList.add('hidden');
      return true;
    }
  } catch (e) {
    setSyncState('error', 'Connection failed ‚Äî check your URL and try again');
  }
  return false;
}

async function loadFromSheet() {
  if (!SCRIPT_URL) return;
  showLoading('Loading from Google Sheets...');
  try {
    const res = await fetch(`${SCRIPT_URL}?t=${Date.now()}`);
    const data = await res.json();
    if (data.items) items = data.items.map(i => ({...i, id: Number(i.id), stock: Number(i.stock), price: Number(i.price), maxCapacity: Number(i.maxCapacity), reorderPoint: Number(i.reorderPoint), gstRate: Number(i.gstRate)}));
    if (data.suppliers) suppliers = data.suppliers.map(s => ({...s, id: Number(s.id)}));
    // Load variants from sheet (stored as JSON blob)
    if (data.variants && typeof data.variants === 'object') {
      variants = data.variants;
      localStorage.setItem('sf_variants', JSON.stringify(variants));
    }
    if (data.recipes && typeof data.recipes === 'object') {
      recipes = data.recipes;
      localStorage.setItem('sf_recipes', JSON.stringify(recipes));
    }
    if (data.iterations && Array.isArray(data.iterations)) {
      iterations = data.iterations;
      localStorage.setItem('sf_iterations', JSON.stringify(iterations));
    }

    nextId = items.length > 0 ? Math.max(...items.map(i=>i.id)) + 1 : 1;
    nextSupId = suppliers.length > 0 ? Math.max(...suppliers.map(s=>s.id)) + 1 : 1;

    localStorage.setItem('sf_v3', JSON.stringify(items));
    localStorage.setItem('sf_sup_v3', JSON.stringify(suppliers));
    updateLastSync();
    render();
    toast('‚úÖ', 'Loaded successfully');
  } catch (e) {
    toast('‚ùå', 'Failed to load from Sheets');
  } finally {
    hideLoading();
  }
}

async function syncToSheet(scanLog=null) {
  localStorage.setItem('sf_v3', JSON.stringify(items));
  localStorage.setItem('sf_sup_v3', JSON.stringify(suppliers));
  localStorage.setItem('sf_variants', JSON.stringify(variants));
  localStorage.setItem('sf_recipes', JSON.stringify(recipes));
  localStorage.setItem('sf_iterations', JSON.stringify(iterations));

  if (!SCRIPT_URL || !isConnected) return;

  try {
    setSyncState('syncing', 'Syncing to cloud...');
    const payload = { items, suppliers, variants, recipes, iterations };
    if (scanLog) payload.scanLog = scanLog;
    await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
    updateLastSync();
    setSyncState('connected', 'Connected');
  } catch(e) {
    setSyncState('error', 'Sync failed! Saved locally.');
    console.error('Sync error:', e);
  }
}

async function syncAll() {
  if (isSyncing) return;
  isSyncing = true;
  await syncToSheet(); // Push local changes just in case
  await loadFromSheet(); // Pull fresh
  isSyncing = false;
}

async function connectSheet() {
  const url = document.getElementById('sheet-url-input').value.trim();
  if (!url.includes('script.google.com')) { toast('‚ö†Ô∏è', 'Invalid Google Apps Script URL'); return; }
  SCRIPT_URL = url;
  localStorage.setItem('sf_sheet_url', url);
  if (await pingSheet()) await loadFromSheet();
}

async function connectFromModal() {
  const url = document.getElementById('sheet-url-modal').value.trim();
  if (!url.includes('script.google.com')) { toast('‚ö†Ô∏è', 'Invalid Google Apps Script URL'); return; }
  SCRIPT_URL = url;
  localStorage.setItem('sf_sheet_url', url);
  closeSheetsModal();
  if (await pingSheet()) await loadFromSheet();
}

function setSyncState(state, text) {
  document.getElementById('sync-dot').className = 'sync-dot ' + state;
  document.getElementById('sync-text').textContent = text;
}

function updateLastSync() {
  const now = new Date();
  document.getElementById('last-sync-text').textContent = `Last sync: ${now.toLocaleTimeString()}`;
  localStorage.setItem('sf_last_sync', now.toISOString());
}

function showLoading(t) { document.getElementById('loading-text').textContent=t; document.getElementById('loading').classList.add('show'); }
function hideLoading() { document.getElementById('loading').classList.remove('show'); }
function toast(icon,msg){const el=document.getElementById('toast');document.getElementById('toast-icon').textContent=icon;document.getElementById('toast-msg').textContent=msg;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3000)}

/* ============================================================
   RENDER CORE
   ============================================================ */
function getStatus(i){if(i.stock===0)return'out';if(i.stock<=i.reorderPoint)return'low';return'ok'}
function statusLabel(s){return{ok:'üü¢ In Stock',low:'üü° Low',out:'üî¥ Out'}[s]}
function stockColor(p){if(p>.5)return'var(--accent)';if(p>.2)return'var(--warn)';return'var(--danger)'}

function render() { renderStats(); renderTable(); renderAlerts(); renderMVA(); updateAlertCount(); renderSuppliers(); populateQuickAdd(); }

function renderStats() {
  const out=items.filter(i=>getStatus(i)==='out').length, low=items.filter(i=>getStatus(i)==='low').length;
  const val=items.reduce((s,i)=>s+i.stock*i.price,0);
  document.getElementById('stats-row').innerHTML=[
    {label:'Total SKUs',value:items.length,sub:'unique products',color:'var(--accent)'},
    {label:'Inventory Value',value:'‚Çπ'+val.toLocaleString('en-IN',{maximumFractionDigits:0}),sub:'all locations',color:'var(--blue)'},
    {label:'Low Stock',value:low,sub:'need reorder',color:'var(--warn)'},
    {label:'Out of Stock',value:out,sub:'critical',color:'var(--danger)'},
    {label:'Suppliers',value:suppliers.length,sub:'registered',color:'#c084fc'}
  ].map(r=>`<div class="stat-card" style="--accent-color:${r.color}"><div class="stat-label">${r.label}</div><div class="stat-value" style="color:${r.color}">${r.value}</div><div class="stat-sub">${r.sub}</div></div>`).join('');
}

function getFiltered() {
  const q=document.getElementById('search').value.toLowerCase(), cat=document.getElementById('filter-cat').value, st=document.getElementById('filter-status').value;
  let res=items.filter(i=>{
    if(q&&!i.name.toLowerCase().includes(q)&&!i.sku.toLowerCase().includes(q)&&!(i.barcode||'').includes(q))return false;
    if(cat&&i.category!==cat)return false;
    if(st&&getStatus(i)!==st)return false;
    return true;
  });
  if(sortField)res.sort((a,b)=>{let av=a[sortField],bv=b[sortField];return typeof av==='string'?av.localeCompare(bv)*sortDir:(av-bv)*sortDir});
  return res;
}

function renderTable() {
  const filtered=getFiltered(), total=filtered.length, paged=filtered.slice(page*PAGE,(page+1)*PAGE);
  const tbody=document.getElementById('tbody'), empty=document.getElementById('empty-state');
  if(!paged.length){tbody.innerHTML='';empty.classList.remove('hidden')}
  else{
    empty.classList.add('hidden');
    tbody.innerHTML=paged.map(item=>{
      const pct=item.maxCapacity?item.stock/item.maxCapacity:0, catBadge={Retail:'badge-retail',Warehouse:'badge-warehouse',Manufacturing:'badge-mfg'}[item.category]||'', bc=item.barcode||'';
      return`<tr>
        <td><div class="item-name">${item.name}</div><div class="item-sku">${item.sku}</div>${bc?`<div class="item-barcode">‚ñê${bc}‚ñå</div>`:''}</td>
        <td><span class="badge ${catBadge}">${item.category}</span></td>
        <td><div class="stock-bar-wrap"><div class="stock-bar"><div class="stock-fill" style="width:${Math.min(100,pct*100)}%;background:${stockColor(pct)}"></div></div><span class="stock-num" style="color:${stockColor(pct)}">${item.stock}</span></div></td>
        <td>‚Çπ${item.price.toFixed(2)}</td><td style="color:var(--muted);font-family:'DM Mono',monospace;font-size:12px">${item.reorderPoint}</td><td style="color:var(--muted);font-size:12px">${item.location||'‚Äî'}</td><td style="color:var(--muted);font-size:12px">${item.supplier||'‚Äî'}</td><td>${statusLabel(getStatus(item))}</td>
        <td><div class="actions"><button class="icon-btn" onclick="openModal(${item.id})" title="Edit">‚úèÔ∏è</button><button class="icon-btn" onclick="addToBill(${item.id})" title="Add to GST Bill">üßæ</button><button class="icon-btn del" onclick="deleteItem(${item.id})" title="Delete">üóë</button></div></td>
      </tr>`;
    }).join('');
  }
  const tp=Math.ceil(total/PAGE);
  document.getElementById('pager').innerHTML=`<span class="pager-info">Showing ${Math.min(page*PAGE+1,total)}‚Äì${Math.min((page+1)*PAGE,total)} of ${total}</span><div style="display:flex;gap:6px"><button class="btn btn-ghost btn-sm" onclick="goPage(-1)" ${page===0?'disabled':''}>‚Üê Prev</button><button class="btn btn-ghost btn-sm" onclick="goPage(1)" ${page>=tp-1?'disabled':''}>Next ‚Üí</button></div>`;
}
function goPage(d){page=Math.max(0,page+d);renderTable()}
function sortBy(f){if(sortField===f)sortDir*=-1;else{sortField=f;sortDir=1}renderTable()}

/* ============================================================
   CRUD OPERATIONS (ITEMS & SUPPLIERS)
   ============================================================ */
function openModal(id){
  editingId=id||null;
  document.getElementById('modal-title').textContent=id?'Edit Item':'Add New Item';
  if(id){
    const item=items.find(i=>i.id===id);
    document.getElementById('f-name').value=item.name; document.getElementById('f-sku').value=item.sku; document.getElementById('f-barcode').value=item.barcode||''; document.getElementById('f-cat').value=item.category; document.getElementById('f-loc').value=item.location; document.getElementById('f-stock').value=item.stock; document.getElementById('f-max').value=item.maxCapacity; document.getElementById('f-reorder').value=item.reorderPoint; document.getElementById('f-price').value=item.price; document.getElementById('f-hsn').value=item.hsn||''; document.getElementById('f-gst').value=item.gstRate||18; document.getElementById('f-supplier').value=item.supplier||''; document.getElementById('f-notes').value=item.notes||'';
  } else {
    ['f-name','f-sku','f-barcode','f-loc','f-supplier','f-notes','f-hsn'].forEach(id=>document.getElementById(id).value=''); ['f-stock','f-max','f-reorder','f-price'].forEach(id=>document.getElementById(id).value=''); document.getElementById('f-gst').value=18;
  }
  document.getElementById('modal').classList.add('open');
}

// Override closeModal to ensure the camera shuts off when the modal is closed
function closeModal(){
  if (html5QrcodeScanner) {
    html5QrcodeScanner.clear();
    html5QrcodeScanner = null;
    document.getElementById('reader').style.display = 'none';
  }
  document.getElementById('modal').classList.remove('open');
}

async function saveItem(){
  const name=document.getElementById('f-name').value.trim(), sku=document.getElementById('f-sku').value.trim();
  if(!name||!sku){toast('‚ö†Ô∏è','Name and SKU required');return}
  const data={name,sku,barcode:document.getElementById('f-barcode').value,category:document.getElementById('f-cat').value,location:document.getElementById('f-loc').value,stock:+document.getElementById('f-stock').value||0,maxCapacity:+document.getElementById('f-max').value||100,reorderPoint:+document.getElementById('f-reorder').value||10,price:+document.getElementById('f-price').value||0,hsn:document.getElementById('f-hsn').value,gstRate:+document.getElementById('f-gst').value||18,supplier:document.getElementById('f-supplier').value,notes:document.getElementById('f-notes').value};
  if(editingId){const idx=items.findIndex(i=>i.id===editingId);items[idx]={...items[idx],...data};toast('‚úÖ','Item updated!')}
  else{items.push({id:nextId++,...data});toast('‚úÖ','Item added!')}
  closeModal(); render();
  await syncToSheet(); // Auto-sync
}
async function deleteItem(id){
  if(!confirm('Delete this item?'))return;
  items=items.filter(i=>i.id!==id); render(); toast('üóëÔ∏è','Deleted.');
  await syncToSheet();
}

/* SUPPLIERS */
function renderSuppliers(){
  const tbody=document.getElementById('sup-tbody'),empty=document.getElementById('sup-empty');
  if(!suppliers.length){tbody.innerHTML='';empty.classList.remove('hidden');return}
  empty.classList.add('hidden');
  tbody.innerHTML=suppliers.map(s=>{
    const cnt=items.filter(i=>i.supplier===s.name).length;
    return`<tr><td><strong>${s.name}</strong></td><td>${s.contact||'‚Äî'}</td><td style="color:var(--blue)">${s.email||'‚Äî'}</td><td style="color:var(--muted);font-size:12px">${s.phone||'‚Äî'}</td><td style="font-family:'DM Mono',monospace;font-size:11px">${s.gstin||'‚Äî'}</td><td><span class="badge badge-mfg">${cnt} items</span></td><td style="color:var(--muted);font-size:12px">${s.lastOrder||'‚Äî'}</td><td><div class="actions"><button class="icon-btn" onclick="openSupplierModal(${s.id})">‚úèÔ∏è</button><button class="icon-btn del" onclick="deleteSupplier(${s.id})">üóë</button></div></td></tr>`;
  }).join('');
}
function openSupplierModal(id){
  editingSupId=id||null; document.getElementById('sup-modal-title').textContent=id?'Edit Supplier':'Add Supplier';
  const s=id?suppliers.find(x=>x.id===id):{};
  ['s-name','s-contact','s-email','s-phone','s-gstin','s-addr','s-notes','s-lastorder'].forEach(k=>document.getElementById(k).value=s[k.split('-')[1]]||'');
  document.getElementById('sup-modal').classList.add('open');
}
function closeSupplierModal(){document.getElementById('sup-modal').classList.remove('open')}
async function saveSupplier(){
  const name=document.getElementById('s-name').value.trim();
  if(!name){toast('‚ö†Ô∏è','Name required');return}
  const data={name,contact:document.getElementById('s-contact').value,email:document.getElementById('s-email').value,phone:document.getElementById('s-phone').value,gstin:document.getElementById('s-gstin').value,addr:document.getElementById('s-addr').value,notes:document.getElementById('s-notes').value,lastOrder:document.getElementById('s-lastorder').value};
  if(editingSupId){const idx=suppliers.findIndex(s=>s.id===editingSupId);suppliers[idx]={...suppliers[idx],...data}}
  else{suppliers.push({id:nextSupId++,...data})}
  closeSupplierModal(); render(); toast('‚úÖ', 'Supplier Saved!');
  await syncToSheet();
}
async function deleteSupplier(id){if(!confirm('Delete supplier?'))return;suppliers=suppliers.filter(s=>s.id!==id);render();toast('üóëÔ∏è','Deleted');await syncToSheet();}

/* ============================================================
   TABS & MODALS
   ============================================================ */
function switchTab(tab,btn){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); btn.classList.add('active');
  ['inventory','addstock','deductstock','monitor','variants','charts','suppliers','mva','production','iteration','alerts','gst'].forEach(t=>{
    const el=document.getElementById('tab-'+t); if(el) el.classList.toggle('hidden',t!==tab);
  });
  if(tab==='charts')setTimeout(renderCharts,60);
  if(tab==='gst'){populateQuickAdd();updateBill();}
  if(tab==='addstock'){setTimeout(()=>document.getElementById('add-barcode-input').focus(),100);}
  if(tab==='deductstock'){setTimeout(()=>document.getElementById('deduct-barcode-input').focus(),100);}
  if(tab==='monitor'){setTimeout(()=>{drawFlowChart();runMonitorAlgo();},80);}
  if(tab==='variants'){populateVarProductSelect();renderVarCards();}
  if(tab==='production'){populateProdSelects();renderRecipes();}
  if(tab==='iteration'){populateIterSelects();renderIterations();renderIterSummary();}
}
function showSheetsSetup(){document.getElementById('sheet-url-modal').value=SCRIPT_URL; document.getElementById('sheets-modal').classList.add('open');}
function closeSheetsModal(){document.getElementById('sheets-modal').classList.remove('open');}
function openImportExport(){document.getElementById('ie-modal').classList.add('open')}
function closeIE(){document.getElementById('ie-modal').classList.remove('open')}

/* ============================================================
   IMPORT/EXPORT
   ============================================================ */
function exportCSV(){const cols=['name','sku','barcode','category','stock','maxCapacity','reorderPoint','price','hsn','gstRate','location','supplier','notes'];const csv=[cols.join(','),...items.map(i=>cols.map(c=>`"${i[c]||''}"`).join(','))].join('\n');const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));a.download='inventory.csv';a.click();toast('‚¨áÔ∏è','Exported!');}
function exportJSON(){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(items,null,2)],{type:'application/json'}));a.download='inventory.json';a.click();toast('‚¨áÔ∏è','Exported!')}
async function importCSV(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();
  r.onload=async evt=>{
    const lines=evt.target.result.split('\n').filter(Boolean), headers=lines[0].split(',').map(h=>h.trim().replace(/"/g,'')); let added=0;
    for(let i=1;i<lines.length;i++){
      const vals=lines[i].split(',').map(v=>v.trim().replace(/"/g,'')), obj={}; headers.forEach((h,idx)=>obj[h]=vals[idx]||'');
      if(obj.name&&obj.sku){items.push({id:nextId++,name:obj.name,sku:obj.sku,barcode:obj.barcode||'',category:obj.category||'Retail',stock:+obj.stock||0,maxCapacity:+obj.maxCapacity||100,reorderPoint:+obj.reorderPoint||10,price:+obj.price||0,hsn:obj.hsn||'',gstRate:+obj.gstRate||18,location:obj.location||'',supplier:obj.supplier||'',notes:obj.notes||''});added++}
    }
    render(); closeIE(); toast('‚úÖ',`Imported ${added} items!`); await syncToSheet();
  };r.readAsText(file);
}

/* ============================================================
   MVA & ALERTS & CHARTS
   ============================================================ */
function renderMVA(){
  const retail=items.filter(i=>i.category==='Retail'),wh=items.filter(i=>i.category==='Warehouse'),mfg=items.filter(i=>i.category==='Manufacturing');
  const vOf=a=>a.reduce((s,i)=>s+i.stock*i.price,0), mvaVal=vOf(mfg), rawMat=vOf(wh), mvaIdx=rawMat>0?((mvaVal/rawMat)*100).toFixed(1)+'%':'N/A', fmt=v=>'‚Çπ'+v.toLocaleString('en-IN',{maximumFractionDigits:0});
  document.getElementById('mva-content').innerHTML=`<div class="card"><div class="card-title">üì¶ Inventory by Segment</div>${[['Retail',retail],['Warehouse',wh],['Manufacturing',mfg]].map(([n,a])=>`<div class="card-row"><span class="card-label">${n} <small style="color:var(--muted)">(${a.length} SKUs)</small></span><span class="card-val" style="color:var(--accent)">${fmt(vOf(a))}</span></div>`).join('')}</div><div class="card"><div class="card-title">üè≠ MVA Metrics</div>${[['Raw Material Value (WH)',fmt(rawMat)],['Finished Goods (Mfg)',fmt(mvaVal)],['MVA Index (Mfg√∑Raw√ó100)',mvaIdx],['Avg Unit Price ‚Äî Mfg',mfg.length?'‚Çπ'+(mfg.reduce((s,i)=>s+i.price,0)/mfg.length).toFixed(2):'N/A']].map(([l,v])=>`<div class="card-row"><span class="card-label">${l}</span><span class="card-val">${v}</span></div>`).join('')}</div><div class="card" style="grid-column:1/-1"><div class="card-title">üìä Stock Health by Segment</div><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:6px">${[['Retail',retail,'#5eb8ff'],['Warehouse',wh,'var(--warn)'],['Manufacturing',mfg,'var(--accent)']].map(([n,a,c])=>{const ok=a.filter(i=>getStatus(i)==='ok').length,low=a.filter(i=>getStatus(i)==='low').length,out=a.filter(i=>getStatus(i)==='out').length;return`<div><div style="color:${c};font-weight:600;margin-bottom:7px">${n}</div>${[['In Stock',ok,'var(--accent)'],['Low Stock',low,'var(--warn)'],['Out of Stock',out,'var(--danger)']].map(([l,v,cc])=>`<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border)"><span style="color:var(--muted);font-size:12px">${l}</span><span style="color:${cc};font-family:'DM Mono',monospace">${v}</span></div>`).join('')}</div>`;}).join('')}</div></div>`;
}
function renderCharts(){
  if(document.getElementById('tab-charts').classList.contains('hidden'))return;
  const catColors={Retail:'#5eb8ff',Warehouse:'#ffd166',Manufacturing:'#00e5a0'};
  if(charts['chart-stock'])charts['chart-stock'].destroy(); charts['chart-stock']=new Chart(document.getElementById('chart-stock'),{type:'bar',data:{labels:items.map(i=>i.name.length>12?i.name.substring(0,12)+'‚Ä¶':i.name),datasets:[{label:'Stock',data:items.map(i=>i.stock),backgroundColor:items.map(i=>(catColors[i.category]||'#888')+'33'),borderColor:items.map(i=>catColors[i.category]||'#888'),borderWidth:1.5,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#7a8ba0',font:{size:10}},grid:{color:'#2a334720'}},y:{ticks:{color:'#7a8ba0',font:{size:10}},grid:{color:'#2a334740'}}}}});
  if(charts['chart-pie'])charts['chart-pie'].destroy(); const cats=['Retail','Warehouse','Manufacturing']; charts['chart-pie']=new Chart(document.getElementById('chart-pie'),{type:'doughnut',data:{labels:cats,datasets:[{data:cats.map(c=>items.filter(i=>i.category===c).reduce((s,i)=>s+i.stock*i.price,0)),backgroundColor:cats.map(c=>catColors[c]+'99'),borderColor:cats.map(c=>catColors[c]),borderWidth:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#e8edf5',font:{size:11}}}}}});
  if(charts['chart-value'])charts['chart-value'].destroy(); const top10=[...items].sort((a,b)=>(b.stock*b.price)-(a.stock*a.price)).slice(0,10); charts['chart-value']=new Chart(document.getElementById('chart-value'),{type:'bar',data:{labels:top10.map(i=>i.name.length>18?i.name.substring(0,18)+'‚Ä¶':i.name),datasets:[{label:'Value (‚Çπ)',data:top10.map(i=>+(i.stock*i.price).toFixed(0)),backgroundColor:'#00e5a033',borderColor:'#00e5a0',borderWidth:1.5,borderRadius:5}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#7a8ba0',font:{size:10}},grid:{color:'#2a334740'}},y:{ticks:{color:'#e8edf5',font:{size:11}},grid:{color:'#2a334720'}}}}});
}

/* ============================================================
   GST BILL BUILDER
   ============================================================ */
function addBillItem(desc='',qty=1,rate=0,gst=18){
  const id=++billRowId, div=document.createElement('div'); div.className='gst-item-row'; div.id='brow-'+id;
  div.innerHTML=`<input class="form-input" placeholder="Item / description" value="${desc}" oninput="updateBill()"><input class="form-input" type="number" min="1" value="${qty}" oninput="updateBill()"><input class="form-input" type="number" min="0" step="0.01" value="${rate}" oninput="updateBill()"><select class="form-input" onchange="updateBill()"><option value="0" ${gst==0?'selected':''}>0%</option><option value="5" ${gst==5?'selected':''}>5%</option><option value="12" ${gst==12?'selected':''}>12%</option><option value="18" ${gst==18?'selected':''}>18%</option><option value="28" ${gst==28?'selected':''}>28%</option></select><button class="rm-btn" onclick="this.parentElement.remove();updateBill()">‚úï</button>`;
  document.getElementById('bill-items-container').appendChild(div); updateBill();
}
function getBillRows(){const rows=[]; document.querySelectorAll('#bill-items-container .gst-item-row').forEach(row=>{const inputs=row.querySelectorAll('input,select'), desc=inputs[0].value.trim(), qty=+inputs[1].value||0, rate=+inputs[2].value||0, gst=+inputs[3].value||0; rows.push({desc,qty,rate,gst,taxable:qty*rate});}); return rows.filter(r=>r.desc||r.rate>0);}
function populateQuickAdd(){const sel=document.getElementById('inv-quick-add'); if(!sel)return; const cur=sel.value; sel.innerHTML='<option value="">‚Äî Pick an inventory item ‚Äî</option>'+items.map(i=>`<option value="${i.id}">${i.name} (‚Çπ${i.price} | GST ${i.gstRate}%)</option>`).join(''); sel.value=cur;}
function quickAddItem(sel){const id=+sel.value; if(!id)return; const item=items.find(i=>i.id===id); if(item)addBillItem(`${item.name} [${item.sku}]`,1,item.price,item.gstRate||18); sel.value='';}
function addToBill(itemId){const item=items.find(i=>i.id===itemId); if(!item)return; switchTab('gst',document.querySelectorAll('.tab')[7]); setTimeout(()=>addBillItem(`${item.name} [${item.sku}]`,1,item.price,item.gstRate||18),120); toast('üßæ','Added to GST Bill!');}
function clearBill(){if(!confirm('Clear all items?'))return; document.getElementById('bill-items-container').innerHTML=''; billRowId=0; addBillItem(); toast('üóëÔ∏è','Cleared.');}

function updateBill(){
  const v=id=>document.getElementById(id).value, sellName=v('g-sell-name')||'Your Business', isInter=v('g-txn-type')==='inter', rows=getBillRows(); let subtotal=0, totalGst=0;
  const rowsHtml=rows.map((r,idx)=>{
    const tax=r.taxable*r.gst/100; subtotal+=r.taxable; totalGst+=tax; const half=(tax/2).toFixed(2);
    const gstCols=isInter?`<td align="right">‚Çπ${tax.toFixed(2)}</td>`:`<td align="right">‚Çπ${half}</td><td align="right">‚Çπ${half}</td>`;
    return`<tr><td>${idx+1}</td><td>${r.desc||'‚Äî'}</td><td align="right">${r.qty}</td><td align="right">‚Çπ${r.rate.toFixed(2)}</td><td align="right">‚Çπ${r.taxable.toFixed(2)}</td><td align="right">${r.gst}%</td>${gstCols}<td align="right"><strong>‚Çπ${(r.taxable+tax).toFixed(2)}</strong></td></tr>`;
  }).join('');
  const discount=+v('g-discount')||0, grandTotal=subtotal+totalGst-discount, gstHeader=isInter?'<th align="right">IGST</th>':'<th align="right">CGST</th><th align="right">SGST</th>', gstTotals=isInter?`<div class="bill-total-row"><span>IGST</span><span>‚Çπ${totalGst.toFixed(2)}</span></div>`:`<div class="bill-total-row"><span>CGST (50%)</span><span>‚Çπ${(totalGst/2).toFixed(2)}</span></div><div class="bill-total-row"><span>SGST (50%)</span><span>‚Çπ${(totalGst/2).toFixed(2)}</span></div>`;

  document.getElementById('bill-preview').innerHTML=`
    <div class="bill-header"><div class="bill-company">${sellName}</div><div class="bill-meta"><div style="grid-column:1/-1;margin-top:4px;font-size:16px;font-weight:800;color:#00e5a0;letter-spacing:1px">TAX INVOICE</div><div>Invoice No: <strong style="color:#fff">${v('g-inv-no')}</strong></div><div>Date: <strong style="color:#fff">${v('g-inv-date')}</strong></div></div></div>
    <div class="bill-section" style="display:grid;grid-template-columns:1fr 1fr;gap:14px">
      <div><div style="font-size:9px;color:#999;text-transform:uppercase;margin-bottom:3px">From</div><strong>${sellName}</strong><br><span style="font-size:11px;color:#555">${v('g-sell-addr')}<br>GSTIN: ${v('g-sell-gstin')||'‚Äî'}</span></div>
      <div><div style="font-size:9px;color:#999;text-transform:uppercase;margin-bottom:3px">Bill To</div><strong>${v('g-buy-name')||'Customer'}</strong><br><span style="font-size:11px;color:#555">${v('g-buy-addr')||'‚Äî'}<br>GSTIN: ${v('g-buy-gstin')||'‚Äî'}</span></div>
    </div>
    <div class="bill-section" style="padding:0"><table class="bill-items-table"><thead><tr><th>#</th><th>Description</th><th align="right">Qty</th><th align="right">Rate</th><th align="right">Taxable</th><th align="right">GST%</th>${gstHeader}<th align="right">Total</th></tr></thead><tbody>${rowsHtml||'<tr><td colspan="9" style="text-align:center;padding:18px">Add items</td></tr>'}</tbody></table></div>
    <div class="bill-totals"><div class="bill-total-row"><span>Subtotal (Taxable)</span><span>‚Çπ${subtotal.toFixed(2)}</span></div>${discount>0?`<div class="bill-total-row"><span>Discount</span><span style="color:#ff4757">-‚Çπ${discount.toFixed(2)}</span></div>`:''}${gstTotals}<div class="bill-total-row grand"><span>GRAND TOTAL</span><span>‚Çπ${grandTotal.toFixed(2)}</span></div></div>
  `;
}
function printBill(){window.print()}

/* ============================================================
   STOCK MONITOR FLOWCHART
   ============================================================ */
function drawFlowChart(){
  const canvas = document.getElementById('flow-canvas');
  const svg = document.getElementById('flow-svg');
  if(!canvas||!svg) return;
  canvas.innerHTML = '';
  canvas.appendChild(svg);
  svg.innerHTML = `<defs><marker id="arrowhead" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="#2a3347"/></marker></defs>`;

  const out=items.filter(i=>getStatus(i)==='out').length;
  const low=items.filter(i=>getStatus(i)==='low').length;
  const ok=items.filter(i=>getStatus(i)==='ok').length;
  const totalVal=items.reduce((s,i)=>s+i.stock*i.price,0);

  // Node definitions: [id, x, y, label, sublabel, class]
  const nodes = [
    ['n-start',   205, 10,  'START',              'Monitor triggered',      'fn-start'],
    ['n-load',    185, 85,  'üì¶ Load Inventory',  items.length+' items',    'fn-process'],
    ['n-loop',    185, 165, 'üîÅ For Each Item',   'iterate all SKUs',       'fn-process'],
    ['n-chk1',   175, 250, '‚ùì stock === 0?',     'Out of stock check',     'fn-decision'],
    ['n-out',    20,  335, 'üî¥ Flag OUT',         out+' items',             'fn-action-red'],
    ['n-chk2',   220, 335, '‚ùì stock ‚â§ reorder?', 'Low stock check',        'fn-decision'],
    ['n-low',    75,  420, 'üü° Flag LOW',         low+' items',             'fn-action-yellow'],
    ['n-ok',     295, 420, 'üü¢ Flag OK',          ok+' items',              'fn-action-green'],
    ['n-reord',  50,  505, 'üìã Calc Reorder Qty', 'max ‚àí stock',            'fn-action-blue'],
    ['n-alert',  185, 505, 'üîî Send Alerts',      'notify team',            'fn-process'],
    ['n-sync',   185, 585, '‚òÅ Sync to Sheet',    '‚Çπ'+totalVal.toLocaleString('en-IN',{maximumFractionDigits:0}), 'fn-process'],
    ['n-end',    205, 660, 'END',                 'cycle complete',          'fn-end'],
  ];

  nodes.forEach(([id,x,y,label,sub,cls])=>{
    const div = document.createElement('div');
    div.id=id; div.className='fn '+cls;
    div.style.left=x+'px'; div.style.top=y+'px';
    div.innerHTML=`<span>${label}</span><span class="fn-label">${sub}</span>`;
    canvas.appendChild(div);
  });

  // Canvas size
  canvas.style.height='720px';

  // Arrows: [x1,y1,x2,y2, label]
  setTimeout(()=>{
    const arrows=[
      ['n-start','n-load',''],
      ['n-load','n-loop',''],
      ['n-loop','n-chk1',''],
      ['n-chk1','n-out','YES'],
      ['n-chk1','n-chk2','NO'],
      ['n-chk2','n-low','YES'],
      ['n-chk2','n-ok','NO'],
      ['n-out','n-reord',''],
      ['n-low','n-reord',''],
      ['n-reord','n-alert',''],
      ['n-ok','n-alert',''],
      ['n-alert','n-sync',''],
      ['n-sync','n-end',''],
    ];
    arrows.forEach(([a,b,lbl])=>{
      const elA=document.getElementById(a), elB=document.getElementById(b);
      if(!elA||!elB) return;
      const ax=elA.offsetLeft+elA.offsetWidth/2, ay=elA.offsetTop+elA.offsetHeight;
      const bx=elB.offsetLeft+elB.offsetWidth/2, by=elB.offsetTop;
      const path=document.createElementNS('http://www.w3.org/2000/svg','path');
      const mx=(ax+bx)/2, my=(ay+by)/2;
      path.setAttribute('d',`M${ax},${ay} C${ax},${my} ${bx},${my} ${bx},${by}`);
      path.setAttribute('stroke','#2a3347');
      path.setAttribute('stroke-width','1.8');
      path.setAttribute('fill','none');
      path.setAttribute('marker-end','url(#arrowhead)');
      svg.appendChild(path);
      if(lbl){
        const txt=document.createElementNS('http://www.w3.org/2000/svg','text');
        txt.setAttribute('x',mx+4); txt.setAttribute('y',my-3);
        txt.setAttribute('fill','#7a8ba0'); txt.setAttribute('font-size','10');
        txt.setAttribute('font-family','DM Sans,sans-serif');
        txt.textContent=lbl; svg.appendChild(txt);
      }
    });
    svg.setAttribute('viewBox',`0 0 ${canvas.offsetWidth} 730`);
  },120);
}

function runMonitorAlgo(){
  const out=items.filter(i=>getStatus(i)==='out');
  const low=items.filter(i=>getStatus(i)==='low');
  const ok=items.filter(i=>getStatus(i)==='ok');

  // Output summary
  const outEl=document.getElementById('algo-output-list');
  if(outEl) outEl.innerHTML=[
    ['Total Items',items.length,'var(--text)'],
    ['Out of Stock',out.length,'var(--danger)'],
    ['Low Stock',low.length,'var(--warn)'],
    ['Healthy',ok.length,'var(--accent)'],
    ['Total Value','‚Çπ'+items.reduce((s,i)=>s+i.stock*i.price,0).toLocaleString('en-IN',{maximumFractionDigits:0}),'var(--blue)'],
  ].map(([l,v,c])=>`<div class="card-row"><span class="card-label">${l}</span><span class="card-val" style="color:${c}">${v}</span></div>`).join('');

  const monItem=(i,extra='')=>`<div class="mon-item">
    <div class="mon-dot" style="background:${getStatus(i)==='out'?'var(--danger)':getStatus(i)==='low'?'var(--warn)':'var(--accent)'}"></div>
    <div class="mon-name">${i.name}<div style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">${i.sku}${extra}</div></div>
    <div class="mon-stock" style="color:${getStatus(i)==='out'?'var(--danger)':getStatus(i)==='low'?'var(--warn)':'var(--accent)'}">${i.stock}</div>
  </div>`;

  const outListEl=document.getElementById('mon-out-list');
  if(outListEl) outListEl.innerHTML=out.length?out.map(i=>monItem(i)).join(''):'<div style="color:var(--muted);font-size:12px">üéâ None out of stock</div>';

  const lowListEl=document.getElementById('mon-low-list');
  if(lowListEl) lowListEl.innerHTML=low.length?low.map(i=>monItem(i,` ¬∑ reorder ${i.maxCapacity-i.stock}`)).join(''):'<div style="color:var(--muted);font-size:12px">‚úÖ All above reorder point</div>';

  const okListEl=document.getElementById('mon-ok-list');
  if(okListEl) okListEl.innerHTML=ok.length?ok.slice(0,5).map(i=>monItem(i)).join('')+(ok.length>5?`<div style="color:var(--muted);font-size:11px;padding:6px 0">+${ok.length-5} more healthy items</div>`:''):'<div style="color:var(--muted);font-size:12px">No items yet</div>';

  drawFlowChart();
  toast('üîÑ','Monitor algorithm ran ‚Äî results updated!');
}


/* ============================================================
   PRODUCT VARIANTS  ‚Äî Multi-Attribute Matrix System
   variants[pid] = {
     axes: [ { name:'Color', values:[{label,color}] }, { name:'Size', values:[{label}] } ],
     combos: [ { key:'Red|S', labels:['Red','S'], sku, barcode, stock, reorderPoint, color } ]
   }
   ============================================================ */
let variants = JSON.parse(localStorage.getItem('sf_variants')||'{}');

// ‚îÄ‚îÄ Axis builder state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let varAxes = []; // [ { name, values:[{label, color}], isColor } ]

function addVarAxis(name='', values=[], isColor=false){
  const axisId = 'axis-' + Date.now() + Math.random().toString(36).slice(2,6);
  varAxes.push({ id: axisId, name, values, isColor });
  renderAxes();
}

function removeVarAxis(axisId){
  varAxes = varAxes.filter(a=>a.id!==axisId);
  renderAxes();
}

function addAxisValue(axisId, label, color='#00e5a0'){
  const axis = varAxes.find(a=>a.id===axisId);
  if(!axis||!label.trim()) return;
  if(axis.values.find(v=>v.label.toLowerCase()===label.trim().toLowerCase())){
    toast('‚ö†Ô∏è','Value already exists'); return;
  }
  axis.values.push({ label: label.trim(), color });
  renderAxes();
}

function removeAxisValue(axisId, idx){
  const axis = varAxes.find(a=>a.id===axisId);
  if(axis) axis.values.splice(idx,1);
  renderAxes();
}

function renderAxes(){
  const container = document.getElementById('var-axes-container');
  if(!container) return;
  container.innerHTML = varAxes.map((axis,aIdx)=>{
    const tags = axis.values.map((v,vIdx)=>`
      <span class="var-axis-tag" style="${axis.isColor?'border-color:'+v.color+';background:'+v.color+'22':''}" >
        ${axis.isColor?`<span style="width:9px;height:9px;border-radius:50%;background:${v.color};border:1px solid rgba(255,255,255,.25);flex-shrink:0"></span>`:''}
        ${v.label}
        <button class="var-axis-tag-del" onclick="removeAxisValue('${axis.id}',${vIdx})">√ó</button>
      </span>`).join('');

    return`<div class="var-axis" id="${axis.id}">
      <div class="var-axis-header">
        <div style="display:flex;flex-direction:column;gap:4px;flex:1">
          <div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.4px">Attribute Name</div>
          <input class="var-axis-name-input" value="${axis.name}" placeholder="e.g. Color, Size, Material"
            oninput="varAxes.find(a=>a.id==='${axis.id}').name=this.value">
        </div>
        <label style="display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);cursor:pointer;margin-left:10px;margin-top:16px">
          <input type="checkbox" ${axis.isColor?'checked':''} onchange="varAxes.find(a=>a.id==='${axis.id}').isColor=this.checked;renderAxes()"> Has colours
        </label>
        <button class="prod-del" onclick="removeVarAxis('${axis.id}')" style="margin-top:14px;margin-left:8px">‚úï</button>
      </div>
      <div class="var-axis-values" id="tags-${axis.id}">${tags||'<span style="color:var(--muted);font-size:12px">No values yet</span>'}</div>
      <div class="var-axis-add-wrap">
        <input class="var-axis-value-input" id="inp-${axis.id}" placeholder="Add value, press Enter"
          onkeydown="if(event.key==='Enter'){event.preventDefault();addAxisValueFromInput('${axis.id}')}">
        ${axis.isColor?`<input type="color" class="var-axis-color-input" id="col-${axis.id}" value="#00e5a0">`:''}
        <button class="btn btn-ghost btn-sm" onclick="addAxisValueFromInput('${axis.id}')">Add</button>
      </div>
    </div>`;
  }).join('');
}

function addAxisValueFromInput(axisId){
  const inp = document.getElementById('inp-'+axisId);
  const colInp = document.getElementById('col-'+axisId);
  if(!inp||!inp.value.trim()) return;
  addAxisValue(axisId, inp.value.trim(), colInp?colInp.value:'#00e5a0');
  inp.value = '';
}

// ‚îÄ‚îÄ Presets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function applyPreset(preset){
  varAxes = [];
  const presets = {
    bandana: [
      { name:'Color', isColor:true, values:[
        {label:'Red',color:'#ff4757'},{label:'Blue',color:'#5eb8ff'},
        {label:'Pink',color:'#ff6b9d'},{label:'Yellow',color:'#ffd166'},
        {label:'Green',color:'#34a853'},{label:'Purple',color:'#c084fc'}
      ]},
      { name:'Size', isColor:false, values:[
        {label:'XS'},{label:'S'},{label:'M'},{label:'L'},{label:'XL'}
      ]}
    ],
    tshirt: [
      { name:'Color', isColor:true, values:[
        {label:'White',color:'#e8edf5'},{label:'Black',color:'#1a1a2e'},
        {label:'Navy',color:'#2d3a6b'},{label:'Red',color:'#ff4757'}
      ]},
      { name:'Size', isColor:false, values:[
        {label:'XS'},{label:'S'},{label:'M'},{label:'L'},{label:'XL'},{label:'XXL'}
      ]}
    ],
    shoes: [
      { name:'Color', isColor:true, values:[
        {label:'Black',color:'#1a1a2e'},{label:'White',color:'#e8edf5'},{label:'Brown',color:'#8B4513'}
      ]},
      { name:'Size', isColor:false, values:[
        {label:'6'},{label:'7'},{label:'8'},{label:'9'},{label:'10'},{label:'11'}
      ]}
    ],
    colorsonly: [
      { name:'Color', isColor:true, values:[
        {label:'Red',color:'#ff4757'},{label:'Blue',color:'#5eb8ff'},
        {label:'Green',color:'#34a853'},{label:'Black',color:'#1a1a2e'},
        {label:'White',color:'#e8edf5'},{label:'Yellow',color:'#ffd166'}
      ]}
    ],
    sizesonly: [
      { name:'Size', isColor:false, values:[
        {label:'XS'},{label:'S'},{label:'M'},{label:'L'},{label:'XL'},{label:'XXL'}
      ]}
    ]
  };
  const data = presets[preset]||[];
  data.forEach(a=>{
    varAxes.push({ id:'axis-'+Date.now()+Math.random().toString(36).slice(2,6), name:a.name, values:a.values, isColor:a.isColor });
  });
  renderAxes();
  toast('‚úÖ', preset.charAt(0).toUpperCase()+preset.slice(1)+' preset loaded ‚Äî click Generate!');
}

// ‚îÄ‚îÄ Cartesian product of all axes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function cartesian(axes){
  if(!axes.length) return [[]];
  const [first, ...rest] = axes;
  const restCombos = cartesian(rest);
  return first.values.flatMap(v => restCombos.map(combo => [v, ...combo]));
}

// ‚îÄ‚îÄ Generate matrix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generateMatrix(){
  const pid = document.getElementById('var-product-sel').value;
  if(!pid){ toast('‚ö†Ô∏è','Select a product first'); return; }
  if(!varAxes.length){ toast('‚ö†Ô∏è','Add at least one attribute (e.g. Color)'); return; }
  if(varAxes.some(a=>!a.values.length)){ toast('‚ö†Ô∏è','Each attribute needs at least one value'); return; }

  const item    = items.find(i=>i.id==pid);
  const combos  = cartesian(varAxes); // array of [val, val, ...] per axis
  const defaultStock   = parseInt(document.getElementById('var-default-stock').value)||0;
  const defaultReorder = parseInt(document.getElementById('var-default-reorder').value)||5;
  const defaultCost    = parseFloat(document.getElementById('var-default-cost').value)||0;
  const defaultPrice   = parseFloat(document.getElementById('var-default-price').value)||(item?item.price:0);
  const parentSku = item ? item.sku : '';

  // If editing existing, preserve existing stock/barcode/cost/price
  const existing = variants[pid] ? variants[pid].combos : [];
  const existingMap = {};
  existing.forEach(c=>{ existingMap[c.key]=c; });

  const rows = combos.map(combo=>{
    const key    = combo.map(v=>v.label).join('|');
    const labels = combo.map(v=>v.label);
    const skuSuffix = '-'+labels.map(l=>l.toUpperCase().replace(/\s+/g,'')).join('-');
    const colorVal = combo.find((_,i)=>varAxes[i].isColor);
    const ex = existingMap[key];
    return {
      key,
      labels,
      sku: parentSku+skuSuffix,
      barcode     : ex ? ex.barcode||'' : '',
      stock       : ex ? ex.stock : defaultStock,
      reorderPoint: ex ? ex.reorderPoint : defaultReorder,
      cost        : ex ? (ex.cost??defaultCost) : defaultCost,
      sellPrice   : ex ? (ex.sellPrice??defaultPrice) : defaultPrice,
      color       : colorVal ? colorVal.color : '#00e5a0'
    };
  });

  // Show matrix editor
  renderMatrixEditor(pid, rows);
  document.getElementById('var-matrix-editor').style.display='block';
  document.getElementById('var-matrix-editor').scrollIntoView({behavior:'smooth'});
}

let pendingMatrix = { pid: null, rows: [] };

function renderMatrixEditor(pid, rows){
  pendingMatrix = { pid, rows };
  const item = items.find(i=>i.id==pid);
  document.getElementById('matrix-editor-title').textContent = (item?item.name:'Product') + ' ‚Äî Combination Matrix';
  document.getElementById('matrix-editor-sub').textContent = rows.length + ' combinations √ó ' + varAxes.length + ' attributes ‚Äî set stock, cost & sell price per variant';

  const axisNames = varAxes.map(a=>a.name);

  const thead = `<thead><tr>
    ${axisNames.map(n=>`<th class="matrix-th">${n}</th>`).join('')}
    <th class="matrix-th">SKU</th>
    <th class="matrix-th">Barcode</th>
    <th class="matrix-th">Stock</th>
    <th class="matrix-th" style="color:var(--warn)">Min ‚ö†</th>
    <th class="matrix-th" style="color:var(--blue)">Cost ‚Çπ</th>
    <th class="matrix-th" style="color:var(--accent)">Sell ‚Çπ</th>
    <th class="matrix-th" style="color:var(--green)">Margin</th>
  </tr></thead>`;

  const tbody = '<tbody>'+rows.map((row,rIdx)=>{
    const labelCells = row.labels.map((lbl,i)=>{
      const isColorAxis = varAxes[i]&&varAxes[i].isColor;
      const axisVal = varAxes[i]?(varAxes[i].values.find(v=>v.label===lbl)||{}):{}; 
      return`<td class="matrix-td">
        <div class="matrix-combo-label">
          ${isColorAxis?`<span class="matrix-color-dot" style="background:${axisVal.color||'#00e5a0'}"></span>`:''}
          <span>${lbl}</span>
        </div>
      </td>`;
    }).join('');
    const margin = row.sellPrice>0 ? Math.round((row.sellPrice-row.cost)/row.sellPrice*100) : 0;
    const mColor = margin>=40?'var(--accent)':margin>=20?'var(--warn)':'var(--danger)';
    return`<tr id="mrow-${rIdx}">
      ${labelCells}
      <td class="matrix-td"><span class="matrix-sku-badge">${row.sku}</span></td>
      <td class="matrix-td"><input class="matrix-barcode-input" data-row="${rIdx}" data-field="barcode" value="${row.barcode}" placeholder="EAN"></td>
      <td class="matrix-td"><input class="matrix-input" data-row="${rIdx}" data-field="stock" type="number" min="0" value="${row.stock}"></td>
      <td class="matrix-td"><input class="matrix-input warn-input" data-row="${rIdx}" data-field="reorderPoint" type="number" min="0" value="${row.reorderPoint}"></td>
      <td class="matrix-td"><input class="matrix-input" data-row="${rIdx}" data-field="cost" type="number" min="0" step="0.01" value="${row.cost}" style="border-color:var(--blue);width:70px"></td>
      <td class="matrix-td"><input class="matrix-input" data-row="${rIdx}" data-field="sellPrice" type="number" min="0" step="0.01" value="${row.sellPrice}" style="border-color:var(--accent);width:70px"></td>
      <td class="matrix-td" id="margin-${rIdx}" style="text-align:center;font-family:'DM Mono',monospace;font-size:12px;font-weight:700;color:${mColor}">${margin}%</td>
    </tr>`;
  }).join('')+'</tbody>';

  document.getElementById('matrix-table').innerHTML = thead+tbody;

  // Live update pendingMatrix.rows on input + recalc margin
  document.querySelectorAll('#matrix-table input[data-row]').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const r = parseInt(inp.dataset.row);
      const f = inp.dataset.field;
      if(f==='barcode') pendingMatrix.rows[r][f] = inp.value;
      else pendingMatrix.rows[r][f] = parseFloat(inp.value)||0;
      // Recalc margin live
      const row = pendingMatrix.rows[r];
      if(f==='cost'||f==='sellPrice'){
        const margin = row.sellPrice>0 ? Math.round((row.sellPrice-row.cost)/row.sellPrice*100) : 0;
        const mColor = margin>=40?'var(--accent)':margin>=20?'var(--warn)':'var(--danger)';
        const mCell = document.getElementById('margin-'+r);
        if(mCell){ mCell.textContent=margin+'%'; mCell.style.color=mColor; }
      }
    });
  });
}

// ‚îÄ‚îÄ Save ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveVariants(){
  const { pid, rows } = pendingMatrix;
  if(!pid||!rows.length){ toast('‚ö†Ô∏è','Generate combinations first'); return; }

  variants[pid] = {
    axes   : varAxes.map(a=>({ name:a.name, isColor:a.isColor, values:a.values })),
    combos : rows
  };

  // Update parent item:
  //   stock = sum of all combo stocks
  //   price = stock-weighted average sell price across combos (reflects blended value)
  const parentItem = items.find(i=>i.id==pid);
  if(parentItem){
    const totalStock = rows.reduce((s,r)=>s+r.stock,0);
    parentItem.stock = totalStock;

    // Weighted average sell price
    const weightedPriceSum = rows.reduce((s,r)=>s+(r.sellPrice*(r.stock||1)),0);
    const totalWeight      = rows.reduce((s,r)=>s+(r.stock||1),0);
    parentItem.price = totalWeight>0 ? parseFloat((weightedPriceSum/totalWeight).toFixed(2)) : (rows[0]?.sellPrice||parentItem.price);
  }

  localStorage.setItem('sf_variants', JSON.stringify(variants));
  document.getElementById('var-matrix-editor').style.display='none';
  renderVarCards();
  populateVarProductSelect();
  render();
  syncToSheet();
  toast('‚úÖ', rows.length + ' combinations saved & synced!');
}

// ‚îÄ‚îÄ Populate selects ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populateVarProductSelect(){
  const sel = document.getElementById('var-product-sel');
  const cur = sel.value;
  sel.innerHTML='<option value="">‚Äî Select a product ‚Äî</option>'+
    items.map(i=>`<option value="${i.id}">${i.name} (${i.sku})${variants[i.id]?' ‚úì':''}</option>`).join('');
  sel.value = cur;
  sel.onchange = ()=>{ if(variants[sel.value]) editVariant(sel.value); };
}

function clearVarForm(){
  document.getElementById('var-product-sel').value='';
  varAxes=[];
  renderAxes();
  pendingMatrix={pid:null,rows:[]};
  document.getElementById('var-matrix-editor').style.display='none';
}

function editVariant(pid){
  const v = variants[pid];
  if(!v) return;
  document.getElementById('var-product-sel').value=pid;
  // Restore axes
  varAxes = (v.axes||[]).map(a=>({
    id: 'axis-'+Date.now()+Math.random().toString(36).slice(2,5),
    name: a.name, isColor: a.isColor, values: a.values
  }));
  renderAxes();
  // Re-generate matrix with existing values
  generateMatrix();
  window.scrollTo(0,0);
}

// ‚îÄ‚îÄ Inline stock adjust ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function variantAdjustStock(pid, comboIdx, delta){
  if(!variants[pid]) return;
  const combo = variants[pid].combos[comboIdx];
  if(!combo) return;
  const newStock = Math.max(0, combo.stock + delta);
  const oldStock = combo.stock;
  combo.stock = newStock;

  const parentItem = items.find(i=>i.id==pid);
  if(parentItem){
    const combos = variants[pid].combos;
    parentItem.stock = combos.reduce((s,c)=>s+c.stock,0);
    const totalWeight      = combos.reduce((s,c)=>s+(c.stock||1),0);
    const weightedPriceSum = combos.reduce((s,c)=>s+((c.sellPrice??0)*(c.stock||1)),0);
    if(totalWeight>0 && weightedPriceSum>0)
      parentItem.price = parseFloat((weightedPriceSum/totalWeight).toFixed(2));
  }

  localStorage.setItem('sf_variants', JSON.stringify(variants));

  const mode = delta>0?'add':'deduct';
  const scanLog = {
    timestamp   : new Date().toISOString(),
    mode,
    name        : (parentItem?.name||'')+ ' ['+combo.labels.join(' / ')+']',
    sku         : combo.sku,
    barcode     : combo.barcode||'',
    qty         : Math.abs(delta),
    before      : oldStock,
    after       : newStock,
    variantValue: combo.labels.join(' / '),
    parentSku   : parentItem?.sku||''
  };

  renderVarCards();
  render();
  syncToSheet(scanLog);
  toast(delta>0?'‚úÖ':'üì§', combo.labels.join('/')+': '+oldStock+' ‚Üí '+newStock);
}

function variantQuickSet(pid, comboIdx){
  if(!variants[pid]) return;
  const combo = variants[pid].combos[comboIdx];
  const newVal = prompt(`Set exact stock for "${combo.labels.join(' / ')}":`, combo.stock);
  if(newVal===null) return;
  const parsed = parseInt(newVal);
  if(isNaN(parsed)||parsed<0){ toast('‚ö†Ô∏è','Invalid quantity'); return; }
  const delta = parsed-combo.stock;
  if(delta!==0) variantAdjustStock(pid,comboIdx,delta);
}

// ‚îÄ‚îÄ Status helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getVarStatus(combo){
  if(combo.stock===0) return 'out';
  if(combo.stock<=(combo.reorderPoint??5)) return 'low';
  return 'ok';
}

function getAllVariantAlerts(){
  const alerts=[];
  for(const [pid,vData] of Object.entries(variants)){
    const item=items.find(i=>i.id==pid);
    if(!item) continue;
    (vData.combos||vData.attrs||[]).forEach((c,idx)=>{
      const st=getVarStatus(c);
      if(st!=='ok') alerts.push({pid,idx,item,attr:c,status:st});
    });
  }
  return alerts;
}

// ‚îÄ‚îÄ Render alerts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAlerts(){
  const al=items.filter(i=>getStatus(i)!=='ok').sort((a,b)=>getStatus(a)==='out'?-1:1);
  const el=document.getElementById('alerts-content');
  if(!al.length){el.innerHTML='<div style="color:var(--muted);font-size:13px">üéâ All parent items well stocked!</div>';}
  else{el.innerHTML=al.map(i=>{const c=getStatus(i)==='out';return`<div class="alert-item ${c?'alert-crit':'alert-warn'}"><span>${c?'üî¥':'üü°'}</span><div class="alert-text"><strong>${i.name}</strong> (${i.sku}) ‚Äî ${c?'OUT OF STOCK':'Low: '+i.stock+' left (reorder pt: '+i.reorderPoint+')'}</div><span class="alert-action" onclick="openModal(${i.id})">Restock ‚Üí</span></div>`}).join('');}

  const varAlerts=getAllVariantAlerts();
  const vel=document.getElementById('var-alerts-content');
  const badge=document.getElementById('var-alert-badge');
  if(vel){
    if(!varAlerts.length){
      vel.innerHTML='<div style="color:var(--muted);font-size:13px">üéâ All variants well stocked!</div>';
      if(badge) badge.style.display='none';
    } else {
      if(badge){ badge.textContent=varAlerts.length; badge.style.display='inline'; }
      vel.innerHTML=varAlerts.map(({pid,idx,item,attr,status})=>{
        const isOut=status==='out';
        const rpt=attr.reorderPoint??5;
        const name=attr.labels?attr.labels.join(' / '):(attr.value||'');
        return`<div class="alert-item ${isOut?'alert-crit':'alert-warn'}" style="margin-bottom:8px">
          <span>${isOut?'üî¥':'üü°'}</span>
          <div class="alert-text"><strong>${item.name}</strong> ‚Ä∫ <span style="color:${isOut?'var(--danger)':'var(--warn)'};font-weight:600">${name}</span><br>
          ${isOut?`<span style="color:var(--danger);font-weight:700">OUT OF STOCK</span>`:`<span style="color:var(--warn)">Only <strong>${attr.stock}</strong> left (alert ‚â§${rpt})</span>`}</div>
          <span class="alert-action" onclick="editVariant(${pid});switchTab('variants',document.querySelectorAll('.tab')[4])">Restock ‚Üí</span>
        </div>`;
      }).join('');
    }
  }
}

function updateAlertCount(){
  const total=items.filter(i=>getStatus(i)!=='ok').length+getAllVariantAlerts().length;
  const el=document.getElementById('alert-count');
  el.textContent=total>0?total:''; el.style.display=total>0?'':'none';
}

// ‚îÄ‚îÄ Render variant cards ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderVarCards(){
  const container=document.getElementById('var-cards-container');
  if(!container) return;
  const keys=Object.keys(variants);
  if(!keys.length){
    container.innerHTML='<div style="color:var(--muted);font-size:13px;text-align:center;padding:40px 20px"><div style="font-size:32px;margin-bottom:8px">üé®</div>No variants yet.<br>Select a product and generate combinations.</div>';
    return;
  }

  const allAlerts=getAllVariantAlerts();

  let html='';
  // Global alert panel
  if(allAlerts.length){
    html+=`<div class="var-notif-panel"><div class="var-notif-panel-title">üîî Variant Stock Alerts <span style="background:var(--danger);color:#fff;border-radius:99px;padding:1px 9px;font-size:11px">${allAlerts.length}</span></div>`;
    allAlerts.forEach(({pid,idx,item,attr,status})=>{
      const isOut=status==='out';
      const rpt=attr.reorderPoint??5;
      const name=attr.labels?attr.labels.join(' / '):(attr.value||'');
      html+=`<div class="var-notif-banner ${isOut?'var-notif-out':'var-notif-low'}">
        <div class="var-notif-icon">${isOut?'üî¥':'üü°'}</div>
        <div class="var-notif-text"><strong>${item.name}</strong> ‚Ä∫ <span style="color:${isOut?'var(--danger)':'var(--warn)'};font-weight:600">${name}</span> ‚Äî ${isOut?'<span style="color:var(--danger)">OUT OF STOCK</span>':`<span style="color:var(--warn)">Only <strong>${attr.stock}</strong> left (‚â§${rpt})</span>`}</div>
        <span class="var-notif-restock" onclick="variantAdjustStock(${pid},${idx},${rpt*2||10})">+Restock</span>
      </div>`;
    });
    html+=`</div>`;
  } else {
    html+=`<div style="background:color-mix(in srgb,var(--accent) 8%,transparent);border:1px solid color-mix(in srgb,var(--accent) 25%,transparent);border-radius:10px;padding:11px 16px;margin-bottom:14px;font-size:12px;color:var(--accent)">‚úÖ All variant stocks are healthy</div>`;
  }

  html+=keys.map(pid=>{
    const item=items.find(i=>i.id==pid);
    if(!item) return '';
    const v=variants[pid];
    const combos=v.combos||v.attrs||[];
    const axes=v.axes||[];
    const totalStock   = combos.reduce((s,c)=>s+c.stock,0);
    const totalCostVal = combos.reduce((s,c)=>s+(c.cost??0)*c.stock,0);
    const totalSellVal = combos.reduce((s,c)=>s+(c.sellPrice??0)*c.stock,0);
    const avgMargin    = totalSellVal>0 ? Math.round((totalSellVal-totalCostVal)/totalSellVal*100) : null;
    const productAlerts= allAlerts.filter(a=>a.pid==pid);
    const parentStatusColor=getStatus(item)==='out'?'var(--danger)':getStatus(item)==='low'?'var(--warn)':'var(--accent)';

    // Group combos for display ‚Äî if 2 axes, show as 2D grid; else flat chips
    const is2D = axes.length===2;
    let comboHtml='';

    if(is2D){
      // Build axis0 √ó axis1 grid
      const axis0=axes[0], axis1=axes[1];
      const axis0vals=axis0.values.map(v=>v.label);
      const axis1vals=axis1.values.map(v=>v.label);

      // Header row
      comboHtml+=`<div style="overflow-x:auto"><table style="border-collapse:collapse;font-size:12px;margin-bottom:8px">
        <thead><tr>
          <th style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);font-size:10px;color:var(--muted)">${axis0.name} ‚Üì / ${axis1.name} ‚Üí</th>
          ${axis1vals.map(l=>`<th style="padding:6px 10px;background:var(--surface2);border:1px solid var(--border);font-size:11px;font-weight:600;white-space:nowrap">${l}</th>`).join('')}
        </tr></thead><tbody>`;

      axis0vals.forEach((a0lbl,a0i)=>{
        const a0val=axis0.values[a0i];
        comboHtml+=`<tr><td style="padding:6px 10px;border:1px solid var(--border);font-weight:600;white-space:nowrap;background:var(--surface2)">
          ${axis0.isColor?`<span style="width:9px;height:9px;border-radius:50%;background:${a0val.color};border:1px solid rgba(255,255,255,.2);display:inline-block;margin-right:5px"></span>`:''} ${a0lbl}</td>`;
        axis1vals.forEach((_,a1i)=>{
          const key=a0lbl+'|'+axis1vals[a1i];
          const cIdx=combos.findIndex(c=>c.key===key);
          if(cIdx===-1){ comboHtml+=`<td style="padding:6px;border:1px solid var(--border);text-align:center;color:var(--muted)">‚Äî</td>`; return; }
          const c=combos[cIdx];
          const st=getVarStatus(c);
          const sc=st==='out'?'var(--danger)':st==='low'?'var(--warn)':'var(--accent)';
          const margin = c.sellPrice>0 ? Math.round((c.sellPrice-(c.cost??0))/c.sellPrice*100) : null;
          const mColor = margin===null?'var(--muted)':margin>=40?'var(--accent)':margin>=20?'var(--warn)':'var(--danger)';
          comboHtml+=`<td style="padding:4px 6px;border:1px solid var(--border);text-align:center;background:${st!=='ok'?'color-mix(in srgb,'+sc+' 8%,transparent)':''}">
            <div style="font-family:'DM Mono',monospace;font-size:13px;font-weight:700;color:${sc}">${c.stock}</div>
            <div style="font-size:9px;color:var(--muted)">min ${c.reorderPoint??5}</div>
            ${c.sellPrice>0?`<div style="font-size:9px;margin-top:2px">
              <span style="color:var(--blue)">‚Çπ${(c.cost??0).toFixed(0)}</span>
              <span style="color:var(--muted)">‚Üí</span>
              <span style="color:var(--accent)">‚Çπ${c.sellPrice.toFixed(0)}</span>
            </div>`:''}
            ${margin!==null?`<div style="font-size:9px;color:${mColor};font-weight:700">${margin}% margin</div>`:''}
            <div style="display:flex;gap:2px;margin-top:3px;justify-content:center">
              <button onclick="variantAdjustStock(${pid},${cIdx},-1)" style="width:20px;height:20px;background:color-mix(in srgb,var(--danger) 15%,transparent);border:1px solid var(--danger);color:var(--danger);border-radius:4px;cursor:pointer;font-size:12px;padding:0">‚àí</button>
              <button onclick="variantQuickSet(${pid},${cIdx})" style="width:20px;height:20px;background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:4px;cursor:pointer;font-size:10px;padding:0">‚úè</button>
              <button onclick="variantAdjustStock(${pid},${cIdx},1)" style="width:20px;height:20px;background:color-mix(in srgb,var(--green) 15%,transparent);border:1px solid var(--green);color:var(--green);border-radius:4px;cursor:pointer;font-size:12px;padding:0">+</button>
            </div>
          </td>`;
        });
        comboHtml+=`</tr>`;
      });
      comboHtml+=`</tbody></table></div>`;
    } else {
      // Flat chips for single axis or 3+ axes
      comboHtml='<div class="var-grid">'+combos.map((c,cIdx)=>{
        const st=getVarStatus(c);
        const sc=st==='out'?'var(--danger)':st==='low'?'var(--warn)':'var(--accent)';
        const barPct=Math.min(100,c.stock/Math.max(c.stock,(c.reorderPoint??5)*3)*100);
        return`<div class="var-chip" style="background:${c.color+'18'};border-color:${st!=='ok'?sc:c.color};${st!=='ok'?'box-shadow:0 0 8px '+sc+'44':''}">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:3px">
            <div style="display:flex;align-items:center;gap:5px">
              ${c.color&&c.color!=='#00e5a0'?`<span class="var-chip-color" style="background:${c.color}"></span>`:''}
              <strong style="font-size:12px">${c.labels?c.labels.join(' / '):(c.value||'')}</strong>
            </div>
            <span style="font-size:11px">${st==='out'?'üî¥':st==='low'?'üü°':'üü¢'}</span>
          </div>
          <div style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace;margin-bottom:2px">${c.sku||''}</div>
          <div class="var-chip-bar"><div class="var-chip-bar-fill" style="width:${barPct}%;background:${sc}"></div></div>
          <div style="color:${sc};font-size:14px;font-weight:700;margin:5px 0">${c.stock} <span style="font-size:10px;font-weight:400;color:var(--muted)">units</span></div>
          ${(c.cost??0)>0||c.sellPrice>0?`<div style="display:flex;justify-content:space-between;align-items:center;background:var(--surface2);border-radius:6px;padding:5px 8px;margin:4px 0;font-size:11px">
            <div style="text-align:center">
              <div style="color:var(--muted);font-size:9px;text-transform:uppercase;letter-spacing:.3px">Cost</div>
              <div style="color:var(--blue);font-family:'DM Mono',monospace;font-weight:600">‚Çπ${(c.cost??0).toFixed(2)}</div>
            </div>
            <div style="color:var(--border)">‚Üí</div>
            <div style="text-align:center">
              <div style="color:var(--muted);font-size:9px;text-transform:uppercase;letter-spacing:.3px">Sell</div>
              <div style="color:var(--accent);font-family:'DM Mono',monospace;font-weight:600">‚Çπ${(c.sellPrice??0).toFixed(2)}</div>
            </div>
            <div style="text-align:center">
              <div style="color:var(--muted);font-size:9px;text-transform:uppercase;letter-spacing:.3px">Margin</div>
              ${(()=>{ const m=c.sellPrice>0?Math.round((c.sellPrice-(c.cost??0))/c.sellPrice*100):0; const mc=m>=40?'var(--accent)':m>=20?'var(--warn)':'var(--danger)'; return `<div style="color:${mc};font-family:'DM Mono',monospace;font-weight:700">${m}%</div>`; })()}
            </div>
          </div>`:''}
          <div class="var-reorder-badge" style="${st!=='ok'?'border-color:'+sc+';color:'+sc:''}"><span>‚ö† Min:</span> ${c.reorderPoint??5}</div>
          <div style="display:flex;gap:4px;margin-top:6px">
            <button onclick="variantAdjustStock(${pid},${cIdx},-1)" style="flex:1;background:color-mix(in srgb,var(--danger) 15%,transparent);border:1px solid var(--danger);color:var(--danger);border-radius:5px;cursor:pointer;font-size:14px;padding:3px 0;font-weight:700">‚àí</button>
            <button onclick="variantQuickSet(${pid},${cIdx})" style="flex:0;background:var(--surface2);border:1px solid var(--border);color:var(--muted);border-radius:5px;cursor:pointer;font-size:10px;padding:3px 6px">‚úè</button>
            <button onclick="variantAdjustStock(${pid},${cIdx},1)" style="flex:1;background:color-mix(in srgb,var(--green) 15%,transparent);border:1px solid var(--green);color:var(--green);border-radius:5px;cursor:pointer;font-size:14px;padding:3px 0;font-weight:700">+</button>
          </div>
          <div class="var-chip-status" style="background:${sc}"></div>
        </div>`;
      }).join('')+'</div>';
    }

    return`<div class="var-card" style="${productAlerts.length?'border-color:color-mix(in srgb,var(--warn) 40%,transparent)':''}">
      <div class="var-card-header">
        <div>
          <div class="var-card-name">${item.name}
            ${productAlerts.length?`<span style="background:var(--danger);color:#fff;border-radius:99px;padding:1px 8px;font-size:10px;margin-left:6px">${productAlerts.length} alert${productAlerts.length>1?'s':''}</span>`:''}
          </div>
          <div style="font-size:11px;color:var(--muted);font-family:'DM Mono',monospace;margin-top:2px">
            ${item.sku} ¬∑ ${combos.length} combos (${axes.map(a=>a.name).join(' √ó ')}) ¬∑ Parent: <span style="color:${parentStatusColor};font-weight:600">${item.stock} units</span>
          </div>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-ghost btn-sm" onclick="editVariant(${pid})">‚úèÔ∏è Edit</button>
          <button class="btn btn-ghost btn-sm" style="color:var(--danger);border-color:var(--danger)" onclick="deleteVariant(${pid})">üóë</button>
        </div>
      </div>
      ${comboHtml}
      <div class="var-summary">
        <div class="var-summary-item">Combos: <span>${combos.length}</span></div>
        <div class="var-summary-item">Total Stock: <span>${totalStock}</span></div>
        <div class="var-summary-item">Cost Value: <span style="color:var(--blue)">‚Çπ${totalCostVal.toLocaleString('en-IN',{maximumFractionDigits:0})}</span></div>
        <div class="var-summary-item">Sell Value: <span style="color:var(--accent)">‚Çπ${totalSellVal.toLocaleString('en-IN',{maximumFractionDigits:0})}</span></div>
        ${avgMargin!==null?`<div class="var-summary-item">Avg Margin: <span style="color:${avgMargin>=40?'var(--accent)':avgMargin>=20?'var(--warn)':'var(--danger)'}">${avgMargin}%</span></div>`:''}
        <div class="var-summary-item">Alerts: <span style="color:${productAlerts.length?'var(--danger)':'var(--accent)'}">${productAlerts.length}</span></div>
      </div>
    </div>`;
  }).join('');

  container.innerHTML=html;
  updateAlertCount();
}

function deleteVariant(pid){
  if(!confirm('Delete all variants for this product?')) return;
  delete variants[pid];
  localStorage.setItem('sf_variants',JSON.stringify(variants));
  renderVarCards(); populateVarProductSelect(); syncToSheet();
  toast('üóëÔ∏è','Variants deleted');
}

// ‚îÄ‚îÄ Barcode scan integration (multi-combo lookup) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// (processBarcodeScan already uses variants[pid].combos via matchedVarParent logic)
// Override the lookup portion to handle new combo structure:
function findVariantByBarcode(barcode){
  for(const [pid,vData] of Object.entries(variants)){
    const combos=vData.combos||vData.attrs||[];
    const idx=combos.findIndex(c=>c.barcode===barcode||c.sku===barcode);
    if(idx!==-1) return { pid, comboIdx:idx, combo:combos[idx] };
  }
  return null;
}


/* ============================================================
   PRODUCTION RECIPES
   ============================================================ */
let recipes = JSON.parse(localStorage.getItem('sf_recipes')||'{}');
// recipes[itemId] = { batchSize, sellPrice, rawMaterials:[{name,qty,costPerUnit}], labor:[{role,hours,rate}], overhead:[{name,units,costPerUnit}], timeHrs, electricity }

function populateProdSelects(){
  const sel = document.getElementById('prod-item-sel');
  const cur = sel.value;
  sel.innerHTML = '<option value="">‚Äî Select finished product ‚Äî</option>' +
    items.map(i=>`<option value="${i.id}">${i.name} (${i.sku})${recipes[i.id]?' ‚úì':''}</option>`).join('');
  sel.value = cur;
  if(sel.value){ const it=items.find(x=>x.id==sel.value); if(it) document.getElementById('prod-sell-price').value=it.price; }
  sel.onchange = () => {
    const it = items.find(x=>x.id==sel.value);
    if(it) document.getElementById('prod-sell-price').value = it.price;
    if(recipes[sel.value]) loadRecipeIntoForm(sel.value);
  };
}

function addRawRow(name='',qty=1,cost=0){
  const row=document.createElement('div'); row.className='prod-row';
  row.innerHTML=`<input class="prod-input" placeholder="e.g. Wax, Jar, Wick" value="${name}">
    <input class="prod-input" type="number" min="0" step="0.01" value="${qty}" placeholder="Qty">
    <input class="prod-input" type="number" min="0" step="0.01" value="${cost}" placeholder="‚Çπ">
    <button class="prod-del" onclick="this.closest('.prod-row').remove()">‚úï</button>`;
  document.getElementById('raw-rows-container').appendChild(row);
}
function addLaborRow(role='',hrs=1,rate=0){
  const row=document.createElement('div'); row.className='prod-row';
  row.innerHTML=`<input class="prod-input" placeholder="e.g. Pouring, Packing" value="${role}">
    <input class="prod-input" type="number" min="0" step="0.5" value="${hrs}" placeholder="Hrs">
    <input class="prod-input" type="number" min="0" step="0.5" value="${rate}" placeholder="‚Çπ/hr">
    <button class="prod-del" onclick="this.closest('.prod-row').remove()">‚úï</button>`;
  document.getElementById('labor-rows-container').appendChild(row);
}
function addOverheadRow(name='',units=1,cost=0){
  const row=document.createElement('div'); row.className='prod-row';
  row.innerHTML=`<input class="prod-input" placeholder="e.g. Packaging, Transport" value="${name}">
    <input class="prod-input" type="number" min="0" step="0.01" value="${units}" placeholder="Units">
    <input class="prod-input" type="number" min="0" step="0.01" value="${cost}" placeholder="‚Çπ">
    <button class="prod-del" onclick="this.closest('.prod-row').remove()">‚úï</button>`;
  document.getElementById('overhead-rows-container').appendChild(row);
}

function readRows(containerId){
  const rows=[];
  document.querySelectorAll('#'+containerId+' .prod-row').forEach(row=>{
    const ins=row.querySelectorAll('input');
    rows.push({name:ins[0].value.trim(), qty:parseFloat(ins[1].value)||0, cost:parseFloat(ins[2].value)||0});
  });
  return rows.filter(r=>r.name);
}

function saveRecipe(){
  const pid = document.getElementById('prod-item-sel').value;
  if(!pid){ toast('‚ö†Ô∏è','Select a product first'); return; }
  const batchSize  = parseInt(document.getElementById('prod-batch').value)||1;
  const sellPrice  = parseFloat(document.getElementById('prod-sell-price').value)||0;
  const timeHrs    = parseFloat(document.getElementById('prod-time-hrs').value)||0;
  const electricity= parseFloat(document.getElementById('prod-electricity').value)||0;
  const rawMats    = readRows('raw-rows-container');
  const labor      = readRows('labor-rows-container');
  const overhead   = readRows('overhead-rows-container');

  recipes[pid] = {batchSize, sellPrice, rawMaterials:rawMats, labor, overhead, timeHrs, electricity, savedAt: new Date().toISOString()};
  localStorage.setItem('sf_recipes', JSON.stringify(recipes));
  renderRecipes();
  populateProdSelects();
  syncToSheet();
  toast('‚úÖ','Recipe saved & synced!');
}

function calcRecipeCost(r){
  const rawCost      = r.rawMaterials.reduce((s,m)=>s+(m.qty*m.cost),0);
  const laborCost    = r.labor.reduce((s,l)=>s+(l.qty*l.cost),0);
  const overheadCost = r.overhead.reduce((s,o)=>s+(o.qty*o.cost),0);
  const electricityCost = r.electricity||0;
  const totalBatch   = rawCost+laborCost+overheadCost+electricityCost;
  const costPerUnit  = r.batchSize>0 ? totalBatch/r.batchSize : 0;
  const margin       = r.sellPrice>0 ? ((r.sellPrice-costPerUnit)/r.sellPrice*100) : 0;
  const profit       = r.sellPrice - costPerUnit;
  return {rawCost, laborCost, overheadCost, electricityCost, totalBatch, costPerUnit, margin, profit};
}

function loadRecipeIntoForm(pid){
  const r = recipes[pid]; if(!r) return;
  document.getElementById('prod-batch').value = r.batchSize||1;
  document.getElementById('prod-sell-price').value = r.sellPrice||0;
  document.getElementById('prod-time-hrs').value = r.timeHrs||0;
  document.getElementById('prod-electricity').value = r.electricity||0;
  document.getElementById('raw-rows-container').innerHTML='';
  document.getElementById('labor-rows-container').innerHTML='';
  document.getElementById('overhead-rows-container').innerHTML='';
  (r.rawMaterials||[]).forEach(m=>addRawRow(m.name,m.qty,m.cost));
  (r.labor||[]).forEach(l=>addLaborRow(l.name,l.qty,l.cost));
  (r.overhead||[]).forEach(o=>addOverheadRow(o.name,o.qty,o.cost));
}

function clearProdForm(){
  document.getElementById('prod-item-sel').value='';
  document.getElementById('prod-batch').value=10;
  document.getElementById('prod-sell-price').value='';
  document.getElementById('prod-time-hrs').value=2;
  document.getElementById('prod-electricity').value=0;
  document.getElementById('raw-rows-container').innerHTML='';
  document.getElementById('labor-rows-container').innerHTML='';
  document.getElementById('overhead-rows-container').innerHTML='';
  addRawRow(); addRawRow(); addRawRow();
  addLaborRow();
  addOverheadRow();
}

function deleteRecipe(pid){
  if(!confirm('Delete this recipe?')) return;
  delete recipes[pid];
  localStorage.setItem('sf_recipes', JSON.stringify(recipes));
  renderRecipes(); populateProdSelects(); syncToSheet();
  toast('üóëÔ∏è','Recipe deleted');
}

function renderRecipes(){
  const container = document.getElementById('prod-cards-container');
  const keys = Object.keys(recipes);
  if(!keys.length){
    container.innerHTML=`<div style="color:var(--muted);font-size:13px;text-align:center;padding:60px 20px"><div style="font-size:32px;margin-bottom:10px">‚öôÔ∏è</div>No recipes yet. Select a product and fill in the costs.</div>`;
    return;
  }
  container.innerHTML = keys.map(pid=>{
    const item = items.find(i=>i.id==pid);
    if(!item) return '';
    const r = recipes[pid];
    const c = calcRecipeCost(r);
    const marginColor = c.margin>=40?'var(--accent)':c.margin>=20?'var(--warn)':'var(--danger)';
    const profitColor = c.profit>=0?'var(--accent)':'var(--danger)';

    const matRows = (r.rawMaterials||[]).map(m=>`<tr>
      <td>${m.name}</td><td>${m.qty}</td><td>‚Çπ${m.cost.toFixed(2)}</td>
      <td style="color:var(--accent)">‚Çπ${(m.qty*m.cost).toFixed(2)}</td></tr>`).join('');
    const laborRows = (r.labor||[]).map(l=>`<tr>
      <td>${l.name}</td><td>${l.qty} hrs</td><td>‚Çπ${l.cost.toFixed(2)}/hr</td>
      <td style="color:var(--blue)">‚Çπ${(l.qty*l.cost).toFixed(2)}</td></tr>`).join('');
    const ohRows = (r.overhead||[]).map(o=>`<tr>
      <td>${o.name}</td><td>${o.qty}</td><td>‚Çπ${o.cost.toFixed(2)}</td>
      <td style="color:var(--warn)">‚Çπ${(o.qty*o.cost).toFixed(2)}</td></tr>`).join('');

    return`<div class="prod-card">
      <div class="prod-card-header">
        <div>
          <div class="prod-card-name">${item.name}</div>
          <div class="prod-card-sub">${item.sku} ¬∑ Batch: ${r.batchSize} units ¬∑ ‚è± ${r.timeHrs}hrs/batch</div>
        </div>
        <div style="display:flex;gap:7px;align-items:center">
          <button class="btn btn-ghost btn-sm" onclick="loadRecipeIntoForm(${pid});document.getElementById('prod-item-sel').value='${pid}'">‚úèÔ∏è Edit</button>
          <button class="btn btn-ghost btn-sm" style="color:var(--danger);border-color:var(--danger)" onclick="deleteRecipe(${pid})">üóë</button>
        </div>
      </div>

      <!-- Cost breakdown boxes -->
      <div class="prod-cost-grid">
        <div class="prod-cost-box" style="border-top:2px solid var(--accent)">
          <div class="prod-cost-box-label">Raw Materials</div>
          <div class="prod-cost-box-val" style="color:var(--accent)">‚Çπ${c.rawCost.toFixed(0)}</div>
          <div style="font-size:10px;color:var(--muted)">per batch</div>
        </div>
        <div class="prod-cost-box" style="border-top:2px solid var(--blue)">
          <div class="prod-cost-box-label">Labour</div>
          <div class="prod-cost-box-val" style="color:var(--blue)">‚Çπ${c.laborCost.toFixed(0)}</div>
          <div style="font-size:10px;color:var(--muted)">per batch</div>
        </div>
        <div class="prod-cost-box" style="border-top:2px solid var(--warn)">
          <div class="prod-cost-box-label">Overhead+‚ö°</div>
          <div class="prod-cost-box-val" style="color:var(--warn)">‚Çπ${(c.overheadCost+c.electricityCost).toFixed(0)}</div>
          <div style="font-size:10px;color:var(--muted)">per batch</div>
        </div>
        <div class="prod-cost-box" style="border-top:2px solid ${marginColor}">
          <div class="prod-cost-box-label">Margin</div>
          <div class="prod-cost-box-val" style="color:${marginColor}">${c.margin.toFixed(1)}%</div>
          <div style="font-size:10px;color:${profitColor}">‚Çπ${c.profit.toFixed(2)}/unit</div>
        </div>
      </div>

      <!-- Margin bar -->
      <div style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--muted);margin-bottom:4px">
          <span>Cost/unit: <strong style="color:var(--text)">‚Çπ${c.costPerUnit.toFixed(2)}</strong></span>
          <span>Sell: <strong style="color:var(--text)">‚Çπ${r.sellPrice.toFixed(2)}</strong></span>
          <span>Total batch cost: <strong style="color:var(--text)">‚Çπ${c.totalBatch.toFixed(2)}</strong></span>
        </div>
        <div class="prod-margin-bar"><div class="prod-margin-bar-fill" style="width:${Math.max(0,Math.min(100,c.margin))}%;background:${marginColor}"></div></div>
      </div>

      <!-- Detail tables -->
      <details style="margin-bottom:8px">
        <summary style="cursor:pointer;font-size:12px;color:var(--muted);user-select:none;padding:6px 0">‚ñ∏ View full cost breakdown</summary>
        <div style="margin-top:10px">
          ${matRows?`<div style="font-size:10px;color:var(--accent);text-transform:uppercase;font-weight:700;margin-bottom:4px">Raw Materials</div>
          <table class="prod-materials-table"><thead><tr><th>Material</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead><tbody>${matRows}</tbody></table>`:''}
          ${laborRows?`<div style="font-size:10px;color:var(--blue);text-transform:uppercase;font-weight:700;margin-bottom:4px;margin-top:10px">Labour</div>
          <table class="prod-materials-table"><thead><tr><th>Role</th><th>Time</th><th>Rate</th><th>Total</th></tr></thead><tbody>${laborRows}</tbody></table>`:''}
          ${ohRows||r.electricity?`<div style="font-size:10px;color:var(--warn);text-transform:uppercase;font-weight:700;margin-bottom:4px;margin-top:10px">Overhead</div>
          <table class="prod-materials-table"><thead><tr><th>Item</th><th>Units</th><th>Rate</th><th>Total</th></tr></thead>
          <tbody>${ohRows}${r.electricity?`<tr><td>‚ö° Electricity</td><td>1</td><td>‚Çπ${r.electricity}</td><td style="color:var(--warn)">‚Çπ${r.electricity}</td></tr>`:''}</tbody></table>`:''}
        </div>
      </details>
    </div>`;
  }).join('');
}

/* ============================================================
   ITERATION / IMPROVEMENT CYCLES
   ============================================================ */
let iterations = JSON.parse(localStorage.getItem('sf_iterations')||'[]');

function populateIterSelects(){
  ['iter-product-sel','iter-filter-prod'].forEach(id=>{
    const sel=document.getElementById(id); if(!sel) return;
    const cur=sel.value;
    sel.innerHTML=(id==='iter-filter-prod'?'<option value="">All Products</option>':'<option value="">‚Äî Select product ‚Äî</option>')+
      items.map(i=>`<option value="${i.id}">${i.name}</option>`).join('');
    sel.value=cur;
  });
}

function saveIteration(){
  const pid   = document.getElementById('iter-product-sel').value;
  if(!pid){ toast('‚ö†Ô∏è','Select a product first'); return; }
  const title = document.getElementById('iter-title').value.trim();
  if(!title){ toast('‚ö†Ô∏è','Enter a title'); return; }
  const iter = {
    id        : Date.now(),
    pid,
    title,
    category  : document.getElementById('iter-cat').value,
    status    : document.getElementById('iter-status').value,
    costBefore: parseFloat(document.getElementById('iter-cost-before').value)||0,
    costAfter : parseFloat(document.getElementById('iter-cost-after').value)||0,
    what      : document.getElementById('iter-what').value.trim(),
    result    : document.getElementById('iter-result').value.trim(),
    nextStep  : document.getElementById('iter-next').value.trim(),
    date      : new Date().toISOString()
  };
  iterations.unshift(iter);
  localStorage.setItem('sf_iterations', JSON.stringify(iterations));
  renderIterations();
  renderIterSummary();
  clearIterForm();
  syncToSheet();
  toast('‚úÖ','Iteration logged!');
}

function clearIterForm(){
  ['iter-product-sel','iter-title','iter-what','iter-result','iter-next','iter-cost-before','iter-cost-after'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  document.getElementById('iter-status').value='testing';
  document.getElementById('iter-cat').value='material';
}

function deleteIteration(id){
  if(!confirm('Delete this iteration?')) return;
  iterations=iterations.filter(i=>i.id!==id);
  localStorage.setItem('sf_iterations', JSON.stringify(iterations));
  renderIterations(); renderIterSummary(); syncToSheet();
  toast('üóëÔ∏è','Deleted');
}

function updateIterStatus(id, newStatus){
  const it = iterations.find(i=>i.id===id);
  if(!it) return;
  it.status = newStatus;
  localStorage.setItem('sf_iterations', JSON.stringify(iterations));
  renderIterations(); renderIterSummary(); syncToSheet();
  toast('‚úÖ','Status updated');
}

const iterCatLabel={material:'üß™ Raw Material',labor:'üë∑ Labour',overhead:'‚ö° Overhead',process:'‚è± Process',supplier:'üè¢ Supplier',design:'üé® Design/Formula',other:'üìù Other'};
const iterStatusLabel={saving:'üí° Planning',testing:'üß™ Testing',success:'‚úÖ Implemented',failed:'‚ùå Failed'};

function renderIterations(){
  const container = document.getElementById('iter-timeline-container');
  const filterProd   = document.getElementById('iter-filter-prod')?.value||'';
  const filterStatus = document.getElementById('iter-filter-status')?.value||'';
  let list = iterations.filter(i=>{
    if(filterProd && i.pid!=filterProd) return false;
    if(filterStatus && i.status!==filterStatus) return false;
    return true;
  });
  if(!list.length){
    container.innerHTML=`<div style="color:var(--muted);font-size:13px;text-align:center;padding:60px 20px"><div style="font-size:32px;margin-bottom:10px">üîÅ</div>No iterations found.</div>`;
    return;
  }
  container.innerHTML='<div class="iter-timeline">'+list.map(it=>{
    const item=items.find(i=>i.id==it.pid);
    const saving = it.costBefore>0&&it.costAfter>0 ? it.costBefore-it.costAfter : null;
    const savingPct = saving!==null&&it.costBefore>0 ? (saving/it.costBefore*100).toFixed(1) : null;
    const dotColor = {saving:'var(--blue)',testing:'var(--warn)',success:'var(--accent)',failed:'var(--danger)'}[it.status]||'var(--muted)';
    const dateStr  = new Date(it.date).toLocaleDateString('en-IN',{day:'numeric',month:'short',year:'numeric'});
    return`<div class="iter-tl-item">
      <div class="iter-tl-dot" style="border-color:${dotColor};background:color-mix(in srgb,${dotColor} 20%,var(--surface))"></div>
      <div class="iter-card ${it.status}">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">
          <div>
            <div class="iter-card-title">${it.title}</div>
            <div class="iter-card-meta">
              <span>${item?item.name:'Unknown'}</span>
              <span class="iter-tag iter-tag-${it.status}">${iterStatusLabel[it.status]||it.status}</span>
              <span style="font-size:10px;color:var(--muted);font-family:'DM Mono',monospace">${iterCatLabel[it.category]||it.category}</span>
              <span style="font-size:10px;color:var(--muted)">${dateStr}</span>
            </div>
          </div>
          <div style="display:flex;gap:5px;flex-shrink:0">
            <select onchange="updateIterStatus(${it.id},this.value)" style="padding:3px 7px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:11px;outline:none;cursor:pointer">
              <option value="saving" ${it.status==='saving'?'selected':''}>üí° Planning</option>
              <option value="testing" ${it.status==='testing'?'selected':''}>üß™ Testing</option>
              <option value="success" ${it.status==='success'?'selected':''}>‚úÖ Done</option>
              <option value="failed" ${it.status==='failed'?'selected':''}>‚ùå Failed</option>
            </select>
            <button class="prod-del" onclick="deleteIteration(${it.id})">üóë</button>
          </div>
        </div>

        ${saving!==null?`<div class="iter-impact">
          <div style="flex:1">
            <div style="font-size:10px;color:var(--muted);margin-bottom:2px">COST SAVING PER BATCH</div>
            <div class="iter-saving-amt" style="color:${saving>0?'var(--accent)':'var(--danger)'}">${saving>0?'‚àí':'+'} ‚Çπ${Math.abs(saving).toFixed(2)} <span style="font-size:12px;font-weight:400;color:var(--muted)">(${savingPct}%)</span></div>
          </div>
          <div class="iter-compare">
            <div class="iter-compare-box"><div class="iter-compare-label">Before</div><div class="iter-compare-val" style="color:var(--danger)">‚Çπ${it.costBefore.toFixed(2)}</div></div>
            <div class="iter-compare-box"><div class="iter-compare-label">After</div><div class="iter-compare-val" style="color:${saving>0?'var(--accent)':'var(--danger)'}">‚Çπ${it.costAfter.toFixed(2)}</div></div>
          </div>
        </div>`:''}

        ${it.what?`<div style="margin-bottom:6px"><div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px">What Changed</div><div style="font-size:12px">${it.what}</div></div>`:''}
        ${it.result?`<div style="margin-bottom:6px"><div style="font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.3px;margin-bottom:3px">Result</div><div style="font-size:12px;color:var(--muted)">${it.result}</div></div>`:''}
        ${it.nextStep?`<div style="background:var(--surface2);border-radius:7px;padding:7px 11px;font-size:12px">üéØ Next: ${it.nextStep}</div>`:''}
      </div>
    </div>`;
  }).join('')+'</div>';
}

function renderIterSummary(){
  const panel = document.getElementById('iter-summary-panel');
  if(!panel||!iterations.length){ if(panel) panel.innerHTML='<div style="color:var(--muted);font-size:12px">Log iterations to see savings</div>'; return; }
  const done    = iterations.filter(i=>i.status==='success');
  const testing = iterations.filter(i=>i.status==='testing');
  const totalSaving = done.filter(i=>i.costBefore>0&&i.costAfter>0).reduce((s,i)=>s+(i.costBefore-i.costAfter),0);
  const byProd = {};
  done.forEach(i=>{ if(!byProd[i.pid]) byProd[i.pid]=0; if(i.costBefore>0&&i.costAfter>0) byProd[i.pid]+=(i.costBefore-i.costAfter); });
  panel.innerHTML=`
    <div class="card-row"><span class="card-label">Total Iterations</span><span class="card-val">${iterations.length}</span></div>
    <div class="card-row"><span class="card-label">‚úÖ Implemented</span><span class="card-val" style="color:var(--accent)">${done.length}</span></div>
    <div class="card-row"><span class="card-label">üß™ Testing</span><span class="card-val" style="color:var(--warn)">${testing.length}</span></div>
    <div class="card-row"><span class="card-label">üí∞ Total Saved/batch</span><span class="card-val" style="color:var(--accent)">‚Çπ${totalSaving.toFixed(2)}</span></div>
    ${Object.entries(byProd).slice(0,3).map(([pid,sav])=>{
      const it=items.find(i=>i.id==pid);
      return`<div class="card-row"><span class="card-label" style="font-size:11px">${it?it.name:'Unknown'}</span><span class="card-val" style="color:var(--accent);font-size:12px">‚àí‚Çπ${sav.toFixed(2)}</span></div>`;
    }).join('')}`;
}

/* ============================================================
   START APP
   ============================================================ */
async function init() {
  const lastSync = localStorage.getItem('sf_last_sync');
  if (lastSync) document.getElementById('last-sync-text').textContent = `Last sync: ${new Date(lastSync).toLocaleTimeString()}`;

  document.getElementById('g-inv-date').value = new Date().toISOString().split('T')[0];
  const fd = new Date(); fd.setDate(fd.getDate()+30);
  document.getElementById('g-due-date').value = fd.toISOString().split('T')[0];

  // Init variants form
  varAxes = [];
  renderAxes();

  // Init production form with default rows
  addRawRow('',1,0); addRawRow('',1,0); addRawRow('',1,0);
  addLaborRow('',1,0);
  addOverheadRow('',1,0);
  
  render();

  if (SCRIPT_URL) {
    document.getElementById('sheet-url-input').value = SCRIPT_URL;
    if (await pingSheet()) await loadFromSheet();
  } else {
    setSyncState('', 'Not connected ‚Äî paste your Google Apps Script URL to connect');
    document.getElementById('setup-banner').classList.remove('hidden');
  }
}
init();
</script>
</body>
</html>
